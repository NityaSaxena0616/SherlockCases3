<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sherlock Holmes â€” The Mind Palace</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Josefin+Sans:wght@100;300;400;600&family=Special+Elite&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOUNDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --gold:#d4af37;--gold2:rgba(212,175,55,.25);--gold3:rgba(212,175,55,.08);
  --dark:#04040c;--ink:#e8e8e8;--fog:#a8a8b8;
  --red:#cc2222;--blue:#4477cc;
  --glass-bg:rgba(4,4,14,.88);
  --glass-border:rgba(212,175,55,.18);
  --ease:cubic-bezier(.25,.46,.45,.94);
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--dark)}
body{font-family:'Playfair Display',Georgia,serif;color:var(--ink);cursor:none}

/* custom cursor */
#cursor{position:fixed;width:10px;height:10px;border-radius:50%;background:var(--gold);pointer-events:none;z-index:99999;transform:translate(-50%,-50%);transition:width .2s,height .2s,opacity .2s;mix-blend-mode:difference}
#cursor-ring{position:fixed;width:36px;height:36px;border-radius:50%;border:1px solid rgba(212,175,55,.5);pointer-events:none;z-index:99998;transform:translate(-50%,-50%);transition:transform .12s var(--ease),width .3s,height .3s,opacity .3s}
body:hover #cursor{opacity:1}
.hoverable:hover~#cursor,#cursor.hover{width:20px;height:20px}

/* grain overlay */
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' stitchTiles='stitch' type='fractalNoise'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");opacity:.045;pointer-events:none;z-index:9997;animation:grain 12s steps(8) infinite}
@keyframes grain{0%,100%{transform:translate(0,0)}25%{transform:translate(-3%,-8%)}50%{transform:translate(4%,-12%)}75%{transform:translate(-6%,5%)}90%{transform:translate(2%,-4%)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading{position:fixed;inset:0;background:#000;z-index:10000;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:opacity 1.2s var(--ease)}
#loading.fade{opacity:0;pointer-events:none}
.load-eye{width:80px;height:80px;position:relative;margin-bottom:40px}
.load-eye svg{animation:eyeblink 3s ease infinite}
@keyframes eyeblink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.05)}}
.load-label{font-family:'Josefin Sans',sans-serif;font-size:.72em;color:var(--gold);letter-spacing:8px;margin-bottom:28px;animation:pulse 2s ease infinite}
@keyframes pulse{0%,100%{opacity:.35}50%{opacity:1}}
.load-bar{width:240px;height:1px;background:rgba(212,175,55,.12);overflow:hidden}
.load-fill{height:100%;background:var(--gold);width:0;transition:width .3s var(--ease);box-shadow:0 0 16px rgba(212,175,55,.7)}
.load-quote{position:absolute;bottom:48px;font-style:italic;font-size:1em;color:rgba(212,175,55,.38);max-width:500px;text-align:center;padding:0 32px;line-height:1.7}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THREE.JS CANVAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#three-canvas{position:fixed;inset:0;z-index:1;display:none}
#vignette{position:fixed;inset:0;z-index:2;background:radial-gradient(ellipse at 50% 45%,transparent 25%,rgba(4,4,12,.7) 100%);pointer-events:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEDUCTION MODE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#deduction-overlay{position:fixed;inset:0;z-index:50;pointer-events:none;opacity:0;transition:opacity 1s var(--ease)}
#deduction-overlay.active{opacity:1}
#deduction-overlay::before{
  content:'DEDUCTION MODE';position:absolute;
  top:20px;left:50%;transform:translateX(-50%);
  font-family:'Josefin Sans',sans-serif;font-size:.68em;
  color:var(--gold);letter-spacing:8px;
  background:rgba(4,4,14,.9);
  border:1px solid rgba(212,175,55,.3);
  padding:6px 22px 7px;
  animation:dedpulse 2s ease infinite
}
@keyframes dedpulse{0%,100%{opacity:.4}50%{opacity:1}}
#ded-canvas{position:absolute;inset:0;width:100%;height:100%}
#three-canvas{filter:none;transition:filter 1s ease}
#three-canvas.deduction{filter:saturate(0.15) brightness(0.7)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHERLOCK SPEECH BUBBLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sherlock-speech{
  position:fixed;bottom:88px;left:50%;transform:translateX(-50%);
  max-width:600px;width:90%;z-index:500;pointer-events:none;
  opacity:0;transition:opacity .6s var(--ease)
}
#sherlock-speech.show{opacity:1}
.speech-inner{
  background:rgba(4,4,10,.97);border:1px solid var(--gold2);
  padding:20px 28px;position:relative;
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  box-shadow:0 8px 40px rgba(0,0,0,.75),0 0 0 1px rgba(212,175,55,.06) inset;
}
.speech-inner::before{
  content:'SH';position:absolute;top:-1px;left:24px;
  font-family:'Josefin Sans',sans-serif;font-size:.58em;color:var(--gold);
  letter-spacing:3px;background:rgba(4,4,10,.97);padding:0 6px;transform:translateY(-50%)
}
.speech-text{font-style:italic;font-size:1.05em;color:#e0e0d0;line-height:1.75}
.speech-attr{font-family:'Josefin Sans',sans-serif;font-size:.62em;color:rgba(212,175,55,.45);letter-spacing:3px;margin-top:10px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{position:fixed;inset:0;z-index:100;display:none;flex-direction:column;justify-content:center;align-items:center}
.screen.show{display:flex}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: MIND PALACE HUB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-hub{z-index:150;pointer-events:none}
#hub-title{
  position:fixed;top:16px;left:50%;transform:translateX(-50%);
  text-align:center;pointer-events:none;opacity:0;transition:opacity 1s;
  background:rgba(4,4,14,.8);
  border-bottom:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  padding:12px 40px 14px;min-width:280px;
}
#hub-title.show{opacity:1}
.hub-eyebrow{font-family:'Josefin Sans',sans-serif;font-size:.6em;color:rgba(212,175,55,.5);letter-spacing:6px;margin-bottom:8px;transition:all .4s}
.hub-name{font-size:1.65em;color:rgba(232,232,220,.9);letter-spacing:2px}
.hub-case-name{font-family:'Josefin Sans',sans-serif;font-size:.6em;color:rgba(212,175,55,.38);letter-spacing:4px;margin-top:8px;min-height:1em;transition:opacity .5s}
#hub-to-entry{
  position:fixed;top:20px;left:20px;z-index:300;
  font-family:'Josefin Sans',sans-serif;font-size:.62em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;pointer-events:all;
  transition:color .3s,background .3s,border-color .3s;display:none
}
#hub-to-entry:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}
#hub-to-entry.show{display:block}

/* Portal labels â€” 3D projected, glass card treatment */
#portal-labels{position:fixed;inset:0;pointer-events:none;z-index:200}
.portal-label{
  position:absolute;
  transform:translate(-50%,-50%);
  text-align:center;
  cursor:pointer;pointer-events:all;
  opacity:0;
  transition:opacity .5s var(--ease),transform .5s var(--ease);
  /* Glass card */
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  padding:14px 18px 16px;
  min-width:96px;
  box-shadow:0 8px 32px rgba(0,0,0,.65),0 0 0 1px rgba(212,175,55,.05) inset;
}
.portal-label.show{opacity:1}
.portal-label:hover{
  background:rgba(4,4,18,.95);
  border-color:rgba(212,175,55,.38);
  box-shadow:0 12px 40px rgba(0,0,0,.8),0 0 30px rgba(212,175,55,.1);
}
.portal-label:hover .pl-ring{transform:scale(1.2);border-color:var(--gold);box-shadow:0 0 20px rgba(212,175,55,.3)}
.pl-icon{font-size:1.8em;margin-bottom:8px;display:block;filter:drop-shadow(0 0 12px rgba(212,175,55,.5))}
.pl-name{font-family:'Josefin Sans',sans-serif;font-size:.65em;color:var(--gold);letter-spacing:5px;display:block;text-shadow:0 0 20px rgba(212,175,55,.4)}
.pl-ring{
  width:70px;height:70px;border-radius:50%;
  border:1px solid rgba(212,175,55,.3);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 10px;
  transition:all .4s var(--ease);
  background:rgba(4,4,12,.5);
}
.pl-sub{
  font-family:'Josefin Sans',sans-serif;
  font-size:.52em;color:rgba(212,175,55,.4);
  letter-spacing:2px;display:block;margin-top:5px;
  max-width:90px;word-break:break-word;line-height:1.4;
}
.portal-label:hover .pl-sub{color:rgba(212,175,55,.7)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: 221B BAKER STREET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-baker{z-index:300;background:rgba(4,4,8,.0);pointer-events:none}
#baker-room{position:fixed;inset:0;pointer-events:none}
.room-object{position:absolute;cursor:pointer;pointer-events:all;transition:all .4s var(--ease);opacity:0}
.room-object.show{opacity:1}
.room-object:hover .ro-glow{opacity:1;transform:scale(1.1)}
.room-object:hover .ro-label{opacity:1;transform:translateX(-50%) translateY(0)}
.ro-glow{position:absolute;inset:-12px;border-radius:50%;background:radial-gradient(circle,rgba(212,175,55,.12),transparent 70%);opacity:0;transition:all .5s var(--ease);pointer-events:none}
.ro-label{
  position:absolute;bottom:-44px;left:50%;
  transform:translateX(-50%) translateY(6px);
  white-space:nowrap;
  font-family:'Josefin Sans',sans-serif;font-size:.6em;
  color:var(--gold);letter-spacing:3px;
  opacity:0;transition:all .35s var(--ease);pointer-events:none;
  background:rgba(4,4,14,.88);border:1px solid rgba(212,175,55,.2);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:3px 12px 4px;
}
#baker-ui{position:fixed;inset:0;z-index:310;pointer-events:none}
#baker-back{
  position:fixed;top:20px;left:20px;z-index:320;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;pointer-events:all;transition:color .3s,border-color .3s
}
#baker-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}
#baker-hint{
  position:fixed;bottom:32px;left:50%;
  font-family:'Josefin Sans',sans-serif;font-size:.62em;
  color:rgba(212,175,55,.45);letter-spacing:4px;pointer-events:none;
  background:rgba(4,4,14,.75);border:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:5px 20px 6px;
  transform:translateX(-50%);
  animation:float2 4s ease-in-out infinite
}
@keyframes float2{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-5px)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: EVIDENCE BOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-evidence{z-index:300;background:rgba(4,2,2,.97);overflow:hidden}
#evidence-canvas{position:absolute;inset:0;width:100%;height:100%}
#ev-back{
  position:fixed;top:20px;left:20px;z-index:320;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#ev-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}
.ev-pin{position:absolute;cursor:pointer;transform:translate(-50%,-50%);transition:all .4s var(--ease)}
.ev-pin:hover{transform:translate(-50%,-50%) scale(1.1)}
.ev-card{background:rgba(240,230,200,.96);color:#1a1008;padding:10px 12px;font-family:'Special Elite',serif;font-size:.78em;line-height:1.4;max-width:140px;position:relative;box-shadow:4px 4px 18px rgba(0,0,0,.6);border:1px solid rgba(200,180,140,.5)}
.ev-card::after{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:var(--red);border-radius:50%;box-shadow:0 0 8px var(--red)}
.ev-card.selected{box-shadow:0 0 24px rgba(212,175,55,.6),4px 4px 18px rgba(0,0,0,.6)}
#ev-title{
  position:fixed;top:0;left:0;right:0;
  font-family:'Josefin Sans',sans-serif;font-size:.72em;
  color:var(--gold);letter-spacing:6px;pointer-events:none;
  text-align:center;padding:14px 0 13px;
  background:rgba(4,4,14,.92);
  border-bottom:1px solid rgba(212,175,55,.15);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: SUSPECT RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-suspects{z-index:300;background:rgba(4,4,12,.98)}
#suspects-canvas{position:absolute;inset:0;width:100%;height:100%}
#susp-back{
  position:fixed;top:20px;left:20px;z-index:320;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#susp-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}
#susp-info{position:fixed;right:0;top:0;bottom:0;width:360px;background:rgba(4,4,14,.97);border-left:1px solid var(--gold2);padding:48px 32px;transform:translateX(100%);transition:transform .6s var(--ease);z-index:320;overflow-y:auto}
#susp-info.show{transform:translateX(0)}
.si-role{font-family:'Josefin Sans',sans-serif;font-size:.62em;color:var(--gold);letter-spacing:5px;margin-bottom:10px}
.si-name{font-size:2em;margin-bottom:24px;line-height:1.2}
.si-portrait{width:100%;height:200px;margin-bottom:24px;overflow:hidden;border:1px solid var(--gold2)}
.si-bio{font-family:'Josefin Sans',sans-serif;font-size:.82em;color:var(--fog);line-height:1.8;margin-bottom:20px}
.si-verdict{padding:14px 18px;border:1px solid var(--gold2);font-family:'Josefin Sans',sans-serif;font-size:.75em;color:var(--gold);letter-spacing:1px;line-height:1.6;margin-bottom:20px}
.si-close{font-family:'Josefin Sans',sans-serif;font-size:.65em;color:rgba(212,175,55,.45);letter-spacing:3px;background:transparent;border:none;cursor:pointer;transition:color .3s;margin-top:8px}
.si-close:hover{color:var(--gold)}
#susp-hint{
  position:fixed;bottom:28px;left:50%;
  font-family:'Josefin Sans',sans-serif;font-size:.62em;
  color:rgba(212,175,55,.45);letter-spacing:4px;pointer-events:none;
  background:rgba(4,4,14,.75);border:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:5px 20px 6px;
  transform:translateX(-50%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: STORY / CHAPTER MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-story{z-index:300;background:#000;flex-direction:column;overflow:hidden}
.chapter{position:absolute;inset:0;display:none;flex-direction:column;justify-content:flex-end;align-items:center;padding-bottom:96px}
.chapter.on{display:flex}
.ch-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.ch-veil{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.97) 0%,rgba(0,0,0,.45) 55%,rgba(0,0,0,.1) 100%)}
.ch-content{position:relative;z-index:5;max-width:820px;text-align:center;padding:0 40px}
.ch-num{font-family:'Josefin Sans',sans-serif;font-size:.65em;color:var(--gold);letter-spacing:7px;margin-bottom:14px}
.ch-title{font-size:2.6em;color:#f0f0f0;margin-bottom:20px;line-height:1.15}
.ch-text{font-family:'Josefin Sans',sans-serif;font-size:.86em;color:#9a9aaa;line-height:2;max-width:680px;margin:0 auto}
.ch-hl{color:var(--gold);border-bottom:1px solid rgba(212,175,55,.3)}
.ch-nav{position:absolute;bottom:24px;right:36px;display:flex;gap:12px;align-items:center;z-index:10}
.ch-ctr{font-family:'Josefin Sans',sans-serif;font-size:.62em;color:rgba(212,175,55,.4);letter-spacing:3px}
.btn-wire{font-family:'Josefin Sans',sans-serif;font-size:.7em;color:var(--gold);letter-spacing:4px;background:transparent;border:1px solid rgba(212,175,55,.35);padding:9px 24px;cursor:pointer;transition:all .35s var(--ease)}
.btn-wire:hover{background:rgba(212,175,55,.1);border-color:var(--gold);box-shadow:0 0 18px rgba(212,175,55,.25)}
#story-back{
  position:fixed;top:20px;left:20px;z-index:320;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#story-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: DEDUCTION QUIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-deduction{z-index:400;background:rgba(2,2,8,.97)}
.ded-h{font-size:1.8em;color:var(--gold);letter-spacing:2px;margin-bottom:8px;text-align:center;padding:0 32px}
.ded-sub{font-family:'Josefin Sans',sans-serif;font-size:.68em;color:#444;letter-spacing:3px;margin-bottom:52px}
.ded-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(172px,1fr));gap:16px;max-width:920px;width:90%}
.ded-card{padding:26px 20px;background:rgba(6,6,16,.99);border:1px solid rgba(212,175,55,.22);cursor:pointer;transition:all .45s var(--ease);text-align:center;position:relative;overflow:hidden}
.ded-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(212,175,55,.07),transparent);transform:translateX(-100%);transition:transform .6s}
.ded-card:hover::before{transform:translateX(100%)}
.ded-card:hover{transform:translateY(-6px);border-color:var(--gold);box-shadow:0 8px 28px rgba(212,175,55,.22)}
.ded-name{font-size:1.18em;color:#e0e0e0;margin-bottom:8px;letter-spacing:.8px}
.ded-role{font-family:'Josefin Sans',sans-serif;font-size:.7em;color:#555;letter-spacing:1px}
#ded-back{
  position:fixed;top:20px;left:20px;z-index:420;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#ded-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: FINAL REVEAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-reveal{z-index:400;background:rgba(2,2,8,.98);flex-direction:column;overflow-y:auto;padding:40px 20px}
.rv-float{position:fixed;font-family:'Josefin Sans',sans-serif;font-size:.62em;color:rgba(212,175,55,.3);letter-spacing:2px;animation:floatp 7s ease-in-out infinite;pointer-events:none}
@keyframes floatp{0%,100%{transform:translateY(0) rotate(var(--r,0deg))}50%{transform:translateY(-12px) rotate(var(--r,0deg))}}
.rv-sil{position:relative;z-index:5;margin-bottom:28px;animation:risein 1.2s var(--ease) .2s both}
.rv-text{position:relative;z-index:5;max-width:740px;text-align:center;animation:risein 1.1s var(--ease) .8s both;padding:0 28px}
.rv-verdict{font-size:1.8em;color:var(--gold);margin-bottom:18px;letter-spacing:2px}
.rv-explain{font-family:'Josefin Sans',sans-serif;font-size:.84em;color:var(--fog);line-height:1.95;margin-bottom:24px}
.rv-closing{font-style:italic;font-size:1.1em;color:#c0c0cc;border-top:1px solid var(--gold2);padding-top:20px;margin-bottom:30px}
.hl{color:var(--gold);font-weight:700}
@keyframes risein{from{opacity:0;transform:scale(.96) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}
#rv-back{
  position:fixed;top:20px;left:20px;z-index:420;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#rv-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEDUCTION MODE BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ded-mode-btn{position:fixed;bottom:28px;right:28px;z-index:8000;width:52px;height:52px;border-radius:50%;background:rgba(4,4,14,.95);border:1px solid var(--gold2);display:none;align-items:center;justify-content:center;cursor:pointer;font-size:1.3em;transition:all .4s var(--ease);backdrop-filter:blur(12px)}
#ded-mode-btn:hover{border-color:var(--gold);box-shadow:0 0 24px rgba(212,175,55,.4);transform:scale(1.1)}
#ded-mode-btn.on{background:rgba(212,175,55,.18);border-color:var(--gold);box-shadow:0 0 30px rgba(212,175,55,.5)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE (3D horizontal scroll)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-timeline{z-index:300;background:rgba(2,2,10,.98);flex-direction:column;overflow:hidden}
#tl-back{
  position:fixed;top:20px;left:20px;z-index:320;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;transition:color .3s,border-color .3s
}
#tl-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}
#tl-title{font-family:'Josefin Sans',sans-serif;font-size:.72em;color:var(--gold);letter-spacing:6px;margin-bottom:58px}
#tl-track{display:flex;align-items:center;gap:0;overflow-x:auto;width:100%;padding:0 80px 48px;scrollbar-width:none;cursor:grab}
#tl-track:active{cursor:grabbing}
#tl-track::-webkit-scrollbar{display:none}
.tl-line{height:1px;min-width:60px;background:linear-gradient(90deg,transparent,rgba(212,175,55,.3),transparent);flex-shrink:0}
.tl-card{flex-shrink:0;width:220px;background:rgba(6,6,18,.99);border:1px solid rgba(212,175,55,.2);padding:22px 20px;transition:all .45s var(--ease);cursor:pointer;position:relative}
.tl-card:hover,.tl-card.active{border-color:var(--gold);box-shadow:0 0 32px rgba(212,175,55,.2);transform:translateY(-8px)}
.tl-dot{width:10px;height:10px;border-radius:50%;background:var(--gold);position:absolute;bottom:-25px;left:50%;transform:translateX(-50%);box-shadow:0 0 12px rgba(212,175,55,.5)}
.tl-time{font-family:'Josefin Sans',sans-serif;font-size:.6em;color:var(--gold);letter-spacing:4px;margin-bottom:10px}
.tl-event{font-size:1em;color:#e0e0e0;margin-bottom:8px;line-height:1.3}
.tl-detail{font-family:'Josefin Sans',sans-serif;font-size:.72em;color:#606070;line-height:1.6}
#tl-hint{
  font-family:'Josefin Sans',sans-serif;font-size:.62em;
  color:rgba(212,175,55,.45);letter-spacing:4px;
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  pointer-events:none;
  background:rgba(4,4,14,.75);border:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:5px 20px 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  #susp-info{width:100%;top:auto;bottom:0;height:70vh;border-left:none;border-top:1px solid var(--gold2);transform:translateY(100%)}
  #susp-info.show{transform:translateY(0)}
  .ded-grid{grid-template-columns:1fr 1fr}
  .ch-title{font-size:1.8em}
  #tl-track{padding:0 24px 48px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENTRY HUB â€” 3D OBJECT INTERACTION LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#entry-canvas{position:fixed;inset:0;z-index:10;pointer-events:all}
#s-entry{z-index:20;pointer-events:none;background:transparent}

/* Hub object labels â€” glass card with 3D depth */
.hub-obj-label{
  position:fixed;
  pointer-events:none;
  text-align:center;
  z-index:30;
  opacity:0;
  transition:opacity .5s var(--ease), transform .5s var(--ease);
  transform:translateY(12px);
  /* Glass card */
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  padding:14px 22px 16px;
  min-width:160px;
  box-shadow:0 8px 32px rgba(0,0,0,.7),0 0 0 1px rgba(212,175,55,.05) inset;
  overflow:hidden;
}
.hub-obj-label::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,.25),transparent);
}
.hub-obj-label.show{opacity:1;transform:translateY(0)}
.hub-obj-label.hovered .hol-name{color:var(--gold);text-shadow:0 0 28px rgba(212,175,55,.45)}
.hub-obj-label.hovered .hol-eyebrow{opacity:1;letter-spacing:8px}
.hub-obj-label.hovered .hol-hint{opacity:.8}
.hub-obj-label.hovered{
  border-color:rgba(212,175,55,.32);
  box-shadow:0 12px 40px rgba(0,0,0,.8),0 0 20px rgba(212,175,55,.08);
}
.hol-eyebrow{
  font-family:'Josefin Sans',sans-serif;
  font-size:.58em;color:rgba(212,175,55,.6);
  letter-spacing:6px;margin-bottom:6px;
  transition:letter-spacing .4s var(--ease), opacity .3s;
}
.hol-name{
  font-size:1.45em;color:#e0ddd5;
  letter-spacing:2.5px;margin-bottom:5px;
  transition:color .4s, text-shadow .4s;
}
.hol-hint{
  font-family:'Josefin Sans',sans-serif;
  font-size:.56em;color:rgba(212,175,55,.35);
  letter-spacing:3px;
  transition:opacity .3s;
}
.hol-action{
  font-family:'Josefin Sans',sans-serif;
  font-size:.56em;color:var(--gold);
  letter-spacing:4px;margin-top:10px;
  opacity:0;transform:translateY(4px);
  transition:opacity .35s var(--ease), transform .35s var(--ease);
  border:1px solid rgba(212,175,55,.28);
  padding:5px 14px;display:inline-block;
  background:rgba(4,4,14,.85);backdrop-filter:blur(8px);
}
.hub-obj-label.hovered .hol-action{opacity:1;transform:translateY(0)}

/* Entry title overlay */
#entry-title{
  position:fixed;top:0;left:0;right:0;
  display:flex;flex-direction:column;align-items:center;
  padding-top:42px;
  z-index:25;pointer-events:none;
  opacity:0;transition:opacity 1.2s ease
}
#entry-title.show{opacity:1}
.et-top{
  font-family:'Josefin Sans',sans-serif;
  font-size:.62em;color:rgba(212,175,55,.45);
  letter-spacing:8px;margin-bottom:10px
}
.et-main{
  font-size:2.8em;color:rgba(232,228,216,.92);
  letter-spacing:4px;line-height:1.1;text-align:center
}
.et-sub{
  font-family:'Josefin Sans',sans-serif;
  font-size:.65em;color:rgba(212,175,55,.35);
  letter-spacing:5px;margin-top:12px
}

/* Entry bottom hint */
#entry-bottom{
  position:fixed;bottom:32px;left:50%;
  transform:translateX(-50%);
  z-index:25;pointer-events:none;
  opacity:0;transition:opacity 1s ease .8s;
  text-align:center
}
#entry-bottom.show{opacity:1}
.eb-hint{
  font-family:'Josefin Sans',sans-serif;
  font-size:.6em;color:rgba(212,175,55,.45);
  letter-spacing:4px;
  background:rgba(4,4,14,.75);
  border:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:5px 20px 6px;
  display:inline-block;
  animation:breathe 3s ease-in-out infinite
}
@keyframes breathe{0%,100%{opacity:.4}50%{opacity:.9}}

/* Transition wipe */
#scene-wipe{
  position:fixed;inset:0;z-index:9000;
  background:#000;
  opacity:0;pointer-events:none;
  transition:opacity .6s ease
}
#scene-wipe.in{opacity:1;pointer-events:all}
#scene-wipe.out{opacity:0;pointer-events:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CASE SELECTION PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#case-sel-canvas{position:fixed;inset:0;z-index:10;pointer-events:all}
#s-case-sel{z-index:20;pointer-events:none}

#case-sel-title{
  position:fixed;top:0;left:0;right:0;
  display:flex;flex-direction:column;align-items:center;
  padding-top:38px;z-index:25;pointer-events:none;
  opacity:0;transition:opacity 1s ease
}
#case-sel-title.show{opacity:1}
.cst-eyebrow{
  font-family:'Josefin Sans',sans-serif;
  font-size:.6em;color:rgba(212,175,55,.45);letter-spacing:7px;margin-bottom:8px
}
.cst-main{font-size:2em;color:rgba(230,225,210,.9);letter-spacing:3px}

#case-sel-back{
  position:fixed;top:20px;left:20px;z-index:30;
  font-family:'Josefin Sans',sans-serif;font-size:.65em;
  color:rgba(212,175,55,.6);letter-spacing:3px;
  background:rgba(4,4,14,.85);border:1px solid rgba(212,175,55,.18);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:7px 16px;cursor:pointer;
  transition:color .3s,border-color .3s;pointer-events:all
}
#case-sel-back:hover{color:var(--gold);border-color:rgba(212,175,55,.4)}

/* Case labels â€” glass card treatment */
.case-label{
  position:fixed;
  pointer-events:none;
  text-align:center;z-index:25;
  opacity:0;transition:opacity .5s ease,transform .4s ease;
  transform:translateY(6px);
  /* Glass card */
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  padding:14px 20px 16px;
  min-width:200px;
  box-shadow:0 8px 28px rgba(0,0,0,.7);
  overflow:hidden;
}
.case-label::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,.2),transparent);
}
.case-label.show{opacity:1;transform:translateY(0)}
.cl-tag{
  font-family:'Josefin Sans',sans-serif;
  font-size:.55em;color:rgba(212,175,55,.5);letter-spacing:5px;margin-bottom:5px
}
.cl-title{font-size:1.15em;color:#e0ddd0;letter-spacing:1.5px;margin-bottom:4px}
.cl-year{
  font-family:'Josefin Sans',sans-serif;
  font-size:.58em;color:rgba(212,175,55,.38);letter-spacing:3px
}
.case-label.case-hovered{
  border-color:rgba(212,175,55,.32);
  box-shadow:0 12px 40px rgba(0,0,0,.8),0 0 20px rgba(212,175,55,.1);
}
.case-label.case-hovered .cl-title{color:var(--gold);text-shadow:0 0 20px rgba(212,175,55,.4)}
.case-label.case-hovered .cl-tag{opacity:1;letter-spacing:6px}
.case-label.case-hovered .cl-year{color:rgba(212,175,55,.6)}
.case-label .cl-enter{
  font-family:'Josefin Sans',sans-serif;
  font-size:.56em;color:var(--gold);letter-spacing:4px;
  margin-top:10px;opacity:0;transform:translateY(4px);
  transition:opacity .35s var(--ease),transform .35s var(--ease);
  border:1px solid rgba(212,175,55,.25);padding:5px 14px;
  display:inline-block;background:rgba(4,4,14,.85);backdrop-filter:blur(8px);
}
.case-label.case-hovered .cl-enter{opacity:1;transform:translateY(0)}

#case-sel-hint{
  position:fixed;bottom:26px;left:50%;transform:translateX(-50%);
  font-family:'Josefin Sans',sans-serif;font-size:.6em;
  color:rgba(212,175,55,.45);letter-spacing:4px;
  pointer-events:none;z-index:25;
  background:rgba(4,4,14,.75);border:1px solid rgba(212,175,55,.12);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:5px 20px 6px;
  animation:breathe 3s ease-in-out infinite
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3D DEPTH EFFECTS â€” perspective on labels
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.label-3d{
  transform-style:preserve-3d;
  perspective:800px;
}

/* Portal label 3D tilt on hover */
.portal-label{
  transition:opacity .5s var(--ease),transform .4s var(--ease),
             background .3s,border-color .3s,box-shadow .3s;
}
.portal-label.tilted{
  transform:translate(-50%,-50%) perspective(600px) rotateX(var(--tilt-x,0deg)) rotateY(var(--tilt-y,0deg));
}

</style>
</head>
<body>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ENTRY HUB â€” 3D INTERACTIVE LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<canvas id="entry-canvas"></canvas>
<div class="screen" id="s-entry"></div>

<!-- Entry title overlay -->
<div id="entry-title">
  <div class="et-top">LONDON Â· 221B BAKER STREET</div>
  <div class="et-main">Sherlock Holmes</div>
  <div class="et-sub">WHERE DO YOU BEGIN?</div>
</div>

<!-- Entry bottom hint -->
<div id="entry-bottom">
  <div class="eb-hint">HOVER OBJECTS Â· CLICK TO ENTER</div>
</div>

<!-- Hub object labels (positioned by JS) -->
<div class="hub-obj-label" id="lbl-case">
  <div class="hol-eyebrow">INVESTIGATE</div>
  <div class="hol-name">Solve a Case</div>
  <div class="hol-hint">3 cases Â· deduction Â· suspects</div>
  <div class="hol-action">ENTER THE CASE â†—</div>
</div>
<div class="hub-obj-label" id="lbl-shop">
  <div class="hol-eyebrow">ACQUIRE</div>
  <div class="hol-name">The Library</div>
  <div class="hol-hint">novels &amp; collectibles</div>
  <div class="hol-action">OPEN SHOP â†—</div>
</div>
<div class="hub-obj-label" id="lbl-watch">
  <div class="hol-eyebrow">OBSERVE</div>
  <div class="hol-name">The Screening Room</div>
  <div class="hol-hint">films &amp; scenes</div>
  <div class="hol-action">WATCH NOW â†—</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CASE SELECTION PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<canvas id="case-sel-canvas" style="display:none"></canvas>
<div class="screen" id="s-case-sel"></div>

<div id="case-sel-title">
  <div class="cst-eyebrow">SELECT YOUR INVESTIGATION</div>
  <div class="cst-main">Which Case?</div>
</div>

<button id="case-sel-back" onclick="backToEntry()">â† RETURN</button>
<div id="case-sel-hint">HOVER TO EXAMINE Â· CLICK TO INVESTIGATE</div>

<!-- Case labels (positioned by JS) -->
<div class="case-label" id="cl-gtr">
  <div class="cl-tag">TRUE CRIME Â· 1963</div>
  <div class="cl-title">The Great Train Robbery</div>
  <div class="cl-year">Â£2.6 million Â· 15 men Â· one night</div>
  <div class="cl-enter">INVESTIGATE THIS CASE â†—</div>
</div>
<div class="case-label" id="cl-band">
  <div class="cl-tag">HOLMES CANON Â· 1892</div>
  <div class="cl-title">The Speckled Band</div>
  <div class="cl-year">A deadly serpent Â· a locked room</div>
  <div class="cl-enter">INVESTIGATE THIS CASE â†—</div>
</div>
<div class="case-label" id="cl-hound">
  <div class="cl-tag">HOLMES CANON Â· 1902</div>
  <div class="cl-title">The Hound of the Baskervilles</div>
  <div class="cl-year">A spectral beast Â· the Devon moors</div>
  <div class="cl-enter">INVESTIGATE THIS CASE â†—</div>
</div>

<!-- Scene transition wipe -->
<div id="scene-wipe"></div>

<!-- Custom cursor -->
<div id="cursor"></div>
<div id="cursor-ring"></div>

<!-- Loading -->
<div id="loading">
  <div class="load-eye">
    <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg" width="80" height="80">
      <ellipse cx="40" cy="40" rx="36" ry="22" stroke="rgba(212,175,55,0.3)" stroke-width="1"/>
      <ellipse cx="40" cy="40" rx="36" ry="22" stroke="rgba(212,175,55,0.6)" stroke-width="1.5" stroke-dasharray="226" stroke-dashoffset="0" style="animation:rotate 8s linear infinite"/>
      <circle cx="40" cy="40" r="12" fill="rgba(212,175,55,0.15)" stroke="rgba(212,175,55,0.5)" stroke-width="1"/>
      <circle cx="40" cy="40" r="6" fill="rgba(212,175,55,0.6)"/>
      <circle cx="43" cy="37" r="2" fill="rgba(255,255,255,0.4)"/>
    </svg>
  </div>
  <div class="load-label">ENTERING THE MIND PALACE</div>
  <div class="load-bar"><div class="load-fill" id="load-fill"></div></div>
  <div class="load-quote">"When you have eliminated the impossible, whatever remains, however improbable, must be the truth."</div>
</div>

<!-- Three.js canvas -->
<div id="three-canvas"></div>
<div id="vignette"></div>

<!-- Deduction mode overlay -->
<div id="deduction-overlay">
  <canvas id="ded-canvas"></canvas>
</div>

<!-- Deduction mode button -->
<button id="ded-mode-btn" title="Deduction Mode">ğŸ”</button>

<!-- Sherlock speech bubble -->
<div id="sherlock-speech">
  <div class="speech-inner">
    <div class="speech-text" id="speech-text"></div>
    <div class="speech-attr">â€” Sherlock Holmes</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HUB: Mind Palace
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-hub">
  <div id="hub-title">
    <div class="hub-eyebrow" id="hub-eyebrow">THE MIND PALACE</div>
    <div class="hub-name">Sherlock Holmes</div>
    <div class="hub-case-name" id="hub-case-name"></div>
  </div>
  <button id="hub-to-entry" onclick="goToEntry()">â† EXIT MIND PALACE</button>
</div>
<div id="portal-labels">
  <!-- Portals injected by JS -->
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     221B BAKER STREET ROOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-baker">
  <div id="baker-room"><!-- Room objects injected by JS --></div>
  <div id="baker-ui">
    <button id="baker-back" onclick="goHub()">â† MIND PALACE</button>
    <div id="baker-hint">hover objects to interact Â· click to investigate</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVIDENCE BOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-evidence">
  <canvas id="evidence-canvas"></canvas>
  <button id="ev-back" onclick="goHub()">â† MIND PALACE</button>
  <div id="ev-title">EVIDENCE BOARD</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SUSPECT RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-suspects">
  <canvas id="suspects-canvas"></canvas>
  <button id="susp-back" onclick="goHub()">â† MIND PALACE</button>
  <div id="susp-hint">DRAG TO ROTATE Â· CLICK TO EXAMINE</div>
  <div id="susp-info">
    <div class="si-role" id="si-role"></div>
    <div class="si-name" id="si-name"></div>
    <div class="si-portrait" id="si-portrait"></div>
    <div class="si-bio" id="si-bio"></div>
    <div class="si-verdict" id="si-verdict"></div>
    <button class="si-close" onclick="closeSuspectInfo()">CLOSE Ã—</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STORY / CHAPTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-story">
  <button id="story-back" onclick="goHub()">â† MIND PALACE</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEDUCTION QUIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-deduction">
  <div class="ded-h" id="ded-question"></div>
  <div class="ded-sub">ANALYSE Â· DEDUCE Â· CONCLUDE</div>
  <div class="ded-grid" id="ded-grid"></div>
  <button id="ded-back" onclick="goHub()">â† RETURN</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FINAL REVEAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-reveal">
  <div class="rv-float" style="top:12%;left:5%;--r:-4deg">FINGERPRINTS</div>
  <div class="rv-float" style="top:22%;right:6%;--r:3deg;animation-delay:1.5s">Â£2.6 MILLION</div>
  <div class="rv-float" style="top:68%;left:8%;--r:-2deg;animation-delay:.8s">LEATHERSLADE</div>
  <div class="rv-float" style="top:75%;right:7%;--r:4deg;animation-delay:2.2s">BRIDEGO BRIDGE</div>
  <div class="rv-sil">
    <svg width="120" height="220" viewBox="0 0 120 220" fill="none">
      <defs><radialGradient id="shg" cx="50%" cy="30%" r="55%"><stop offset="0%" stop-color="#d4af37" stop-opacity=".15"/><stop offset="100%" stop-color="#d4af37" stop-opacity="0"/></radialGradient></defs>
      <ellipse cx="60" cy="118" rx="54" ry="90" fill="url(#shg)"/>
      <path d="M28 52 Q60 24 92 52 Q86 40 60 37 Q34 40 28 52Z" fill="#2a2a18"/>
      <path d="M28 52 Q12 48 16 56 Q24 60 40 54Z" fill="#2a2a18"/>
      <path d="M92 52 Q108 48 104 56 Q96 60 80 54Z" fill="#2a2a18"/>
      <ellipse cx="60" cy="68" rx="25" ry="22" fill="#c4a080"/>
      <path d="M35 90 Q60 82 85 90 L90 114 Q60 106 30 114Z" fill="#2a2a36"/>
      <path d="M30 114 Q18 126 12 168 Q22 172 42 168 L46 144 Q60 140 74 144 L78 168 Q98 172 108 168 Q102 126 90 114Z" fill="#1a1a28"/>
      <circle cx="106" cy="162" r="13" fill="none" stroke="#d4af37" stroke-width="2.2" opacity=".6"/>
      <line x1="116" y1="173" x2="126" y2="185" stroke="#d4af37" stroke-width="3" opacity=".6"/>
    </svg>
  </div>
  <div class="rv-text">
    <div class="rv-verdict" id="rv-verdict"></div>
    <div class="rv-explain" id="rv-explain"></div>
    <div class="rv-closing" id="rv-closing"></div>
    <button class="btn-wire" onclick="location.reload()">Begin Again</button>
  </div>
  <button id="rv-back" onclick="goHub()">â† MIND PALACE</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CRIME TIMELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-timeline">
  <button id="tl-back" onclick="goHub()">â† MIND PALACE</button>
  <div id="tl-title">CRIME TIMELINE Â· 8th AUGUST 1963</div>
  <div id="tl-track"><!-- Injected by JS --></div>
  <div id="tl-hint">â† DRAG TO TRAVEL THROUGH TIME â†’</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURSOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const cursor = document.getElementById('cursor');
const cursorRing = document.getElementById('cursor-ring');
let mx=0,my=0,rx=0,ry=0;
document.addEventListener('mousemove',e=>{
  mx=e.clientX; my=e.clientY;
  cursor.style.left=mx+'px'; cursor.style.top=my+'px';
});
(function ringLoop(){
  rx+=(mx-rx)*.14; ry+=(my-ry)*.14;
  cursorRing.style.left=rx+'px'; cursorRing.style.top=ry+'px';
  requestAnimationFrame(ringLoop);
})();
document.querySelectorAll('button,a,[onclick]').forEach(el=>{
  el.addEventListener('mouseenter',()=>cursor.classList.add('hover'));
  el.addEventListener('mouseleave',()=>cursor.classList.remove('hover'));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentScreen = null;
function showScreen(id) {
  if(currentScreen==='s-suspects' && id!=='s-suspects'){
    cancelAnimationFrame(suspAnimFrame2); suspAnimFrame2=null;
    if(suspCanvas) { suspCanvas.removeEventListener('click',suspClick); }
    document.getElementById('susp-info').classList.remove('show');
  }
  if(currentScreen==='s-evidence' && id!=='s-evidence'){
    if(evCanvas) { evCanvas.removeEventListener('click',evClick); evCanvas.removeEventListener('mousemove',evHover); }
  }
  if(currentScreen==='s-hub' && id!=='s-hub'){
    document.getElementById('hub-to-entry')?.classList.remove('show');
  }
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
  const el = document.getElementById(id);
  if(el) el.classList.add('show');
  currentScreen = id;
  const btn = document.getElementById('ded-mode-btn');
  btn.style.display = ['s-hub','s-baker','s-story'].includes(id) ? 'flex' : 'none';
  if(id==='s-hub' && currentPhase==='mind-palace'){
    document.getElementById('hub-to-entry')?.classList.add('show');
  }
}

function goToEntry() {
  const wipe = document.getElementById('scene-wipe');
  wipe.classList.add('in');
  setTimeout(()=>{
    if(typeof deductionActive !== 'undefined' && deductionActive) toggleDeductionMode();
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
    document.getElementById('hub-title')?.classList.remove('show');
    document.querySelectorAll('.portal-label').forEach(l=>l.classList.remove('show'));
    document.getElementById('hub-to-entry').classList.remove('show');
    currentPhase = 'entry';
    document.getElementById('three-canvas').style.display='none';
    document.getElementById('entry-canvas').style.display='block';
    document.getElementById('s-entry').classList.add('show');
    document.getElementById('entry-title').classList.add('show');
    document.getElementById('entry-bottom').classList.add('show');
    if(entryCamera){ entryCamera.position.set(0,1.2,18); entryCamera.lookAt(0,0.5,0); entryCamera.rotation.set(0,0,0); }
    if(entryObjects&&entryObjects.shelf) gsap.to(entryObjects.shelf.position,{z:-3.5,duration:.5});
    if(entryObjects&&entryObjects.projector) gsap.to(entryObjects.projector.position,{z:-1.5,duration:.5});
    entryLoop();
    setTimeout(()=>{['lbl-case','lbl-shop','lbl-watch'].forEach((id,i)=>setTimeout(()=>{const el=document.getElementById(id);if(el)el.classList.add('show');},i*150));},400);
    wipe.classList.remove('in'); wipe.classList.add('out');
    setTimeout(()=>wipe.classList.remove('out'),700);
  },650);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THREE.JS MIND PALACE BACKGROUND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let scene, camera, renderer, clock;
let sherlockMesh, mindPalaceGroup, portalMeshes=[], dustSystem;
let camTargetX=0, camTargetY=0;
let portalWorldPositions = []; // 3D world positions of each portal ring

let mindPalaceInited = false;
function initThree() {
  if(mindPalaceInited) return;
  mindPalaceInited = true;
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x01010a);
  scene.fog = new THREE.FogExp2(0x01010a, 0.018);

  camera = new THREE.PerspectiveCamera(58, innerWidth/innerHeight, 0.1, 800);
  camera.position.set(0, 0, 22);

  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.2;
  document.getElementById('three-canvas').appendChild(renderer.domElement);

  clock = new THREE.Clock();

  scene.add(new THREE.AmbientLight(0x080818, 0.5));
  const kl = new THREE.DirectionalLight(0xd4af37, 2.0);
  kl.position.set(-8,14,10); scene.add(kl);
  const rl = new THREE.DirectionalLight(0x2244aa, 0.8);
  rl.position.set(8,4,-12); scene.add(rl);
  const fl = new THREE.PointLight(0xff6622, 1.4, 30);
  fl.position.set(0,-3,8); scene.add(fl);
  window._fireLight = fl;
  const bl = new THREE.PointLight(0x2266cc, 0.6, 25);
  bl.position.set(0,8,-5); scene.add(bl);

  buildMindPalace();
  buildSherlockFigure();
  buildDust();
  buildGroundGrid();

  window.addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  document.addEventListener('mousemove',e=>{
    camTargetX = ((e.clientX/innerWidth)*2-1)*4.0;
    camTargetY = (-(e.clientY/innerHeight)*2+1)*2.5;
  });

  threeLoop();
}

function buildGroundGrid() {
  // Infinite floor grid for depth
  const size = 100, divisions = 40;
  const gridHelper = new THREE.GridHelper(size, divisions, 0xd4af37, 0xd4af37);
  gridHelper.material.transparent = true;
  gridHelper.material.opacity = 0.04;
  gridHelper.position.y = -8;
  scene.add(gridHelper);

  // Reflective floor plane
  const floorGeo = new THREE.PlaneGeometry(100, 100);
  const floorMat = new THREE.MeshStandardMaterial({
    color: 0x01010a, roughness: 0.1, metalness: 0.8
  });
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI/2;
  floor.position.y = -8.05;
  scene.add(floor);
}

function buildMindPalace() {
  mindPalaceGroup = new THREE.Group();
  scene.add(mindPalaceGroup);

  // Central platform â€” double-ring
  const platGeo = new THREE.CylinderGeometry(3.8, 4.5, 0.15, 64);
  const platMat = new THREE.MeshStandardMaterial({
    color: 0x080818, roughness:.35, metalness:.7,
    emissive:0xd4af37, emissiveIntensity:.03
  });
  const plat = new THREE.Mesh(platGeo, platMat);
  plat.position.y = -8; mindPalaceGroup.add(plat);

  // Outer decorative ring
  const outerRing = new THREE.Mesh(
    new THREE.TorusGeometry(4.8, 0.06, 12, 80),
    new THREE.MeshBasicMaterial({color:0xd4af37, transparent:true, opacity:0.15})
  );
  outerRing.rotation.x = Math.PI/2;
  outerRing.position.y = -7.92;
  mindPalaceGroup.add(outerRing);

  const PORTAL_DEFS = [
    {angle:0,     r:10, y:0,    col:0xd4af37},
    {angle:72,    r:10, y:1,    col:0xcc3333},
    {angle:144,   r:10, y:-1,   col:0x4488cc},
    {angle:216,   r:10, y:.5,   col:0x88cc44},
    {angle:288,   r:10, y:-.5,  col:0xcc88ff},
  ];

  portalWorldPositions = [];

  PORTAL_DEFS.forEach((pd,i) => {
    const rad = (pd.angle * Math.PI) / 180;
    const x = Math.cos(rad) * pd.r;
    const z = Math.sin(rad) * pd.r - 4;

    portalWorldPositions.push(new THREE.Vector3(x, pd.y, z));

    // Outer ring (large)
    const rg = new THREE.TorusGeometry(1.8, 0.06, 20, 80);
    const rm = new THREE.MeshStandardMaterial({
      color:pd.col, emissive:pd.col, emissiveIntensity:.9,
      roughness:.15, metalness:.8
    });
    const ring = new THREE.Mesh(rg, rm);
    ring.position.set(x, pd.y, z);
    ring.rotation.x = .12;
    ring.userData = {portalIdx:i, baseX:.12};
    mindPalaceGroup.add(ring);
    portalMeshes.push(ring);

    // Inner ring (counter-rotating)
    const innerRing = new THREE.Mesh(
      new THREE.TorusGeometry(1.2, 0.035, 12, 60),
      new THREE.MeshStandardMaterial({color:pd.col, emissive:pd.col, emissiveIntensity:.6})
    );
    innerRing.position.set(x, pd.y, z);
    innerRing.rotation.x = -.2;
    innerRing.userData = {inner:true, portalIdx:i};
    mindPalaceGroup.add(innerRing);

    // Innermost ring (fastest)
    const coreRing = new THREE.Mesh(
      new THREE.TorusGeometry(0.65, 0.02, 8, 40),
      new THREE.MeshBasicMaterial({color:pd.col, transparent:true, opacity:.9})
    );
    coreRing.position.set(x, pd.y, z);
    coreRing.userData = {core:true, portalIdx:i};
    mindPalaceGroup.add(coreRing);

    // Inner glow disc
    const dg = new THREE.CircleGeometry(1.65, 48);
    const dm = new THREE.MeshBasicMaterial({
      color:pd.col, transparent:true, opacity:.05,
      side:THREE.DoubleSide
    });
    const disc = new THREE.Mesh(dg, dm);
    disc.position.set(x, pd.y, z);
    disc.rotation.x = .12;
    disc.userData = {disc:true, portalIdx:i};
    mindPalaceGroup.add(disc);

    // Pillar of light from below
    const pillarGeo = new THREE.CylinderGeometry(0.05, 0.8, 8, 16, 1, true);
    const pillarMat = new THREE.MeshBasicMaterial({
      color:pd.col, transparent:true, opacity:.04,
      side:THREE.DoubleSide
    });
    const pillar = new THREE.Mesh(pillarGeo, pillarMat);
    pillar.position.set(x, pd.y-4, z);
    mindPalaceGroup.add(pillar);

    addPortalParticles(x, pd.y, z, pd.col);
  });

  // Connecting light threads
  const lineMat = new THREE.LineBasicMaterial({
    color:0xd4af37, transparent:true, opacity:.06
  });
  PORTAL_DEFS.forEach((a,i) => {
    const b = PORTAL_DEFS[(i+1)%PORTAL_DEFS.length];
    const ra = (a.angle*Math.PI)/180, rb = (b.angle*Math.PI)/180;
    const pts = [
      new THREE.Vector3(Math.cos(ra)*a.r, a.y, Math.sin(ra)*a.r-4),
      new THREE.Vector3(0,0,-4),
      new THREE.Vector3(Math.cos(rb)*b.r, b.y, Math.sin(rb)*b.r-4)
    ];
    const lg = new THREE.BufferGeometry().setFromPoints(pts);
    mindPalaceGroup.add(new THREE.Line(lg, lineMat));
  });

  // Floating glyphs
  for(let i=0;i<50;i++) {
    const size = .04 + Math.random()*.1;
    const gg = new THREE.BoxGeometry(size,size,size);
    const gm = new THREE.MeshBasicMaterial({
      color:0xd4af37, transparent:true, opacity:.12+Math.random()*.22
    });
    const glyph = new THREE.Mesh(gg, gm);
    const a = Math.random()*Math.PI*2;
    const r = 3 + Math.random()*16;
    glyph.position.set(
      Math.cos(a)*r, (Math.random()-.5)*12,
      Math.sin(a)*r - 4
    );
    glyph.userData.floatSpeed = .3+Math.random()*.8;
    glyph.userData.floatOffset = Math.random()*Math.PI*2;
    glyph.userData.rotSpeed = (Math.random()-.5)*.5;
    mindPalaceGroup.add(glyph);
  }

  // Nebula-like background sphere
  const nebGeo = new THREE.SphereGeometry(60, 32, 32);
  const nebMat = new THREE.MeshBasicMaterial({
    color:0x0a0820, side:THREE.BackSide, transparent:true, opacity:.6
  });
  scene.add(new THREE.Mesh(nebGeo, nebMat));
}

function addPortalParticles(x, y, z, col) {
  const n = 32;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(n*3);
  for(let i=0;i<n*3;i+=3) {
    const a = Math.random()*Math.PI*2;
    const r = 1.5+Math.random()*1.0;
    pos[i] = x+Math.cos(a)*r;
    pos[i+1] = y+(Math.random()-.5)*2.0;
    pos[i+2] = z+Math.sin(a)*r;
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const mat = new THREE.PointsMaterial({
    color:col, size:.07, transparent:true, opacity:.6,
    blending:THREE.AdditiveBlending, depthWrite:false
  });
  scene.add(new THREE.Points(geo,mat));
}

function buildSherlockFigure() {
  const g = new THREE.Group();
  g.position.set(0,-3.8,-2);
  scene.add(g);
  window._sherlockGroup = g;

  const bm = new THREE.MeshStandardMaterial({color:0x12122a, roughness:.6});
  const sm = new THREE.MeshStandardMaterial({color:0xc4a080, roughness:.55});
  const cm = new THREE.MeshStandardMaterial({color:0x1a1a2a, roughness:.5});

  const body = new THREE.Mesh(new THREE.CylinderGeometry(.55,.8,3.2,12), bm);
  body.position.y=1.4; g.add(body);
  const sh = new THREE.Mesh(new THREE.CylinderGeometry(1.1,.7,.5,16), cm);
  sh.position.y=2.85; g.add(sh);
  const nk = new THREE.Mesh(new THREE.CylinderGeometry(.18,.22,.35,8), sm);
  nk.position.y=3.18; g.add(nk);
  const hd = new THREE.Mesh(new THREE.SphereGeometry(.42,24,24), sm);
  hd.position.y=3.6; g.add(hd);
  const hat = new THREE.Mesh(new THREE.CylinderGeometry(.5,.55,.35,32), bm);
  hat.position.y=3.95; g.add(hat);
  const brim = new THREE.Mesh(new THREE.CylinderGeometry(.7,.7,.04,32), bm);
  brim.position.y=3.82; g.add(brim);
  const pipe = new THREE.Mesh(new THREE.CylinderGeometry(.03,.04,.6,8), new THREE.MeshStandardMaterial({color:0x4a2a08}));
  pipe.position.set(.28,3.42,-.25); pipe.rotation.z=-.5; g.add(pipe);

  // Glowing eyes
  const eyeGeo = new THREE.SphereGeometry(.055,8,8);
  const eyeMat = new THREE.MeshBasicMaterial({color:0xd4af37});
  const le = new THREE.Mesh(eyeGeo, eyeMat);
  le.position.set(-.14,3.64,-.34); g.add(le);
  const re = new THREE.Mesh(eyeGeo, eyeMat);
  re.position.set(.14,3.64,-.34); g.add(re);
  window._sherlockEyes = [le,re];

  // Pipe smoke particles
  const smokeGeo = new THREE.BufferGeometry();
  const smokePos = new Float32Array(20*3);
  for(let i=0;i<20*3;i+=3){
    smokePos[i]=.28+(Math.random()-.5)*.1;
    smokePos[i+1]=3.6+Math.random()*.8;
    smokePos[i+2]=-.25;
  }
  smokeGeo.setAttribute('position',new THREE.BufferAttribute(smokePos,3));
  const smoke = new THREE.Points(smokeGeo, new THREE.PointsMaterial({
    color:0x888899, size:.08, transparent:true, opacity:.3,
    blending:THREE.AdditiveBlending, depthWrite:false
  }));
  g.add(smoke);
  window._sherlockSmoke = smoke;

  const glowGeo = new THREE.SphereGeometry(1.5,16,16);
  const glowMat = new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0,side:THREE.BackSide});
  const glow = new THREE.Mesh(glowGeo, glowMat);
  glow.position.y=2; g.add(glow);
  window._sherlockGlow = glow;
}

function buildDust() {
  const n=1000;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(n*3), vel=[];
  for(let i=0;i<n*3;i+=3){
    pos[i]=(Math.random()-.5)*90;
    pos[i+1]=(Math.random()-.5)*45;
    pos[i+2]=(Math.random()-.5)*90;
    vel.push({
      x:(Math.random()-.5)*.012,
      y:Math.random()*.018-.006,
      z:(Math.random()-.5)*.012
    });
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  dustSystem = new THREE.Points(geo, new THREE.PointsMaterial({
    color:0xaaaacc, size:.12, transparent:true, opacity:.22,
    blending:THREE.AdditiveBlending, depthWrite:false
  }));
  scene.add(dustSystem);
  window._dustVel = vel;
}

function threeLoop() {
  requestAnimationFrame(threeLoop);
  const t = clock.getElapsedTime();

  // Smooth camera with inertia
  camera.position.x += (camTargetX - camera.position.x) * .04;
  camera.position.y += (camTargetY - camera.position.y) * .04;
  camera.position.z = 22 + Math.sin(t*.12)*0.8; // subtle z drift
  camera.lookAt(0,0,-4);

  // Mind palace rotation â€” adds subtle Z tilt for 3D depth
  if(mindPalaceGroup){
    mindPalaceGroup.rotation.y = t*.03;
    mindPalaceGroup.rotation.z = Math.sin(t*.08)*.015;
  }

  // Portal rings â€” multi-layer counter rotation
  mindPalaceGroup.children.forEach(ch=>{
    if(ch.userData.portalIdx !== undefined){
      const i = ch.userData.portalIdx;
      const t2 = t*1.4+i*.9;
      if(!ch.userData.inner && !ch.userData.core && !ch.userData.disc && ch.geometry && ch.geometry.type==='TorusGeometry'){
        // Outer ring
        ch.material.emissiveIntensity = .6 + Math.sin(t2)*.38;
        ch.rotation.z = t*.18*(i%2===0?1:-1);
        ch.rotation.y = Math.sin(t*.3+i)*.15;
      } else if(ch.userData.inner){
        ch.rotation.z = -t*.32*(i%2===0?1:-1);
        ch.rotation.x = -.2 + Math.sin(t*.4+i)*.08;
      } else if(ch.userData.core){
        ch.rotation.z = t*.65*(i%2===0?1:-1);
        ch.rotation.y = t*.4;
      } else if(ch.userData.disc){
        ch.material.opacity = .04 + Math.sin(t2)*.025;
      }
    }
  });

  // Sherlock enhanced animations
  if(window._sherlockGroup){
    const sh = window._sherlockGroup;
    sh.rotation.y = Math.sin(t*.35)*.12;
    sh.rotation.x = Math.sin(t*.22)*.02;
    sh.position.y = Math.sin(t*.55)*.08 - 3.8;
    sh.position.x = Math.sin(t*.28)*.05;

    // Pipe smoke drift
    if(window._sherlockSmoke){
      const sp = window._sherlockSmoke.geometry.attributes.position.array;
      for(let i=0;i<20*3;i+=3){
        sp[i+1] += .003;
        sp[i] += Math.sin(t*2.2+i)*.002;
        if(sp[i+1] > 4.4) { sp[i+1]=3.6; sp[i]=.28+(Math.random()-.5)*.1; }
      }
      window._sherlockSmoke.geometry.attributes.position.needsUpdate=true;
    }
  }

  // Firelight flicker â€” more complex
  if(window._fireLight){
    window._fireLight.intensity = 1.2 + Math.sin(t*7.3)*.2 + Math.sin(t*13.7)*.12 + Math.sin(t*3.1)*.08;
  }

  // Glyphs float with individual rotation
  mindPalaceGroup.children.forEach(ch=>{
    if(ch.userData.floatSpeed){
      ch.position.y += Math.sin(t*ch.userData.floatSpeed + ch.userData.floatOffset)*.005;
      ch.rotation.x += .003 * ch.userData.rotSpeed;
      ch.rotation.y += .002;
      ch.rotation.z += .001 * ch.userData.rotSpeed;
    }
  });

  // Dust
  if(dustSystem){
    const p = dustSystem.geometry.attributes.position.array;
    window._dustVel.forEach((v,i)=>{
      const x=i*3;
      p[x]+=v.x; p[x+1]+=v.y; p[x+2]+=v.z;
      if(Math.abs(p[x])>45) p[x]*=-.97;
      if(p[x+1]>22) p[x+1]=-22;
      if(p[x+1]<-22) p[x+1]=22;
      if(Math.abs(p[x+2])>45) p[x+2]*=-.97;
    });
    dustSystem.geometry.attributes.position.needsUpdate=true;
  }

  renderer.render(scene, camera);

  // Update portal label positions in 3D screen space
  updatePortalLabels3D();
}

// Project 3D portal positions to screen and update labels
function updatePortalLabels3D() {
  if(!mindPalaceGroup || currentPhase !== 'mind-palace') return;
  const labels = document.querySelectorAll('.portal-label');
  labels.forEach((lbl, i) => {
    if(!portalWorldPositions[i]) return;
    // Compute rotated world position
    const localPos = portalWorldPositions[i].clone();
    localPos.applyMatrix4(mindPalaceGroup.matrixWorld);
    // Project to screen
    const v = localPos.clone().project(camera);
    const sx = (v.x * .5 + .5) * innerWidth;
    const sy = (-v.y * .5 + .5) * innerHeight;
    // Only update if visible (z < 1 = in front of camera)
    if(v.z < 1){
      lbl.style.left = sx + 'px';
      lbl.style.top = (sy - 60) + 'px'; // offset above the ring
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEDUCTION MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let deductionActive = false;
let dedCanvas, dedCtx, dedNodes=[], dedAnimFrame;
const DED_BTN = document.getElementById('ded-mode-btn');

function toggleDeductionMode() {
  deductionActive = !deductionActive;
  DED_BTN.classList.toggle('on', deductionActive);
  const overlay = document.getElementById('deduction-overlay');
  const threeEl = document.getElementById('three-canvas');

  if(deductionActive) {
    overlay.classList.add('active');
    threeEl.classList.add('deduction');
    if(window._sherlockGlow) gsap.to(window._sherlockGlow.material,{opacity:.18,duration:1.2});
    initDedCanvas();
    sherlockSpeak('deductionStart');
  } else {
    overlay.classList.remove('active');
    threeEl.classList.remove('deduction');
    if(window._sherlockGlow) gsap.to(window._sherlockGlow.material,{opacity:0,duration:.8});
    cancelAnimationFrame(dedAnimFrame);
    sherlockSpeak('deductionEnd');
  }
}
DED_BTN.addEventListener('click', toggleDeductionMode);

function initDedCanvas() {
  dedCanvas = document.getElementById('ded-canvas');
  dedCtx = dedCanvas.getContext('2d');
  dedCanvas.width = innerWidth; dedCanvas.height = innerHeight;

  const evItems = ['SIGNAL LAMP','BRIDEGO BRIDGE','LEATHERSLADE','JACK MILLS','Â£2.6M','FINGERPRINTS','120 MAILBAGS','ARMY LORRIES','TOMMY BUTLER','MONOPOLY BOARD'];
  dedNodes = evItems.map((item,i)=>({
    label:item,
    x: 80 + Math.random()*(innerWidth-160),
    y: 80 + Math.random()*(innerHeight-160),
    vx:(Math.random()-.5)*.4, vy:(Math.random()-.5)*.4,
    r:38+item.length*2.2, pulse:Math.random()*Math.PI*2, opacity:0
  }));

  const connections = [[0,1],[1,2],[3,0],[4,5],[5,2],[6,1],[7,2],[8,5],[9,2],[3,6]];
  window._dedConns = connections;

  function dedDraw() {
    dedCtx.clearRect(0,0,innerWidth,innerHeight);
    const t = Date.now()*.001;

    dedNodes.forEach(n=>{
      if(n.opacity<1) n.opacity = Math.min(1, n.opacity+.015);
      n.x+=n.vx; n.y+=n.vy;
      if(n.x<n.r||n.x>innerWidth-n.r) n.vx*=-.8;
      if(n.y<n.r||n.y>innerHeight-n.r) n.vy*=-.8;
      n.pulse+=.025;
    });

    connections.forEach(([a,b])=>{
      const na=dedNodes[a], nb=dedNodes[b];
      const alpha = Math.min(na.opacity, nb.opacity)*(.3+Math.sin(t+na.pulse)*.15);
      const grad = dedCtx.createLinearGradient(na.x,na.y,nb.x,nb.y);
      grad.addColorStop(0,`rgba(204,34,34,${alpha})`);
      grad.addColorStop(.5,`rgba(212,175,55,${alpha*.8})`);
      grad.addColorStop(1,`rgba(204,34,34,${alpha})`);
      dedCtx.beginPath();
      dedCtx.moveTo(na.x,na.y); dedCtx.lineTo(nb.x,nb.y);
      dedCtx.strokeStyle=grad; dedCtx.lineWidth=1.2;
      dedCtx.setLineDash([6,4]); dedCtx.stroke();
      dedCtx.setLineDash([]);
      const midX=(na.x+nb.x)/2, midY=(na.y+nb.y)/2;
      dedCtx.beginPath();
      dedCtx.arc(midX,midY,2.5,0,Math.PI*2);
      dedCtx.fillStyle=`rgba(212,175,55,${alpha*1.5})`;
      dedCtx.fill();
    });

    dedNodes.forEach(n=>{
      const glow = dedCtx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r*1.6);
      glow.addColorStop(0,`rgba(212,175,55,${n.opacity*.1})`);
      glow.addColorStop(1,'rgba(0,0,0,0)');
      dedCtx.beginPath();
      dedCtx.arc(n.x,n.y,n.r*1.6,0,Math.PI*2);
      dedCtx.fillStyle=glow; dedCtx.fill();
      dedCtx.beginPath();
      dedCtx.arc(n.x,n.y,n.r,0,Math.PI*2);
      dedCtx.fillStyle=`rgba(4,4,14,${n.opacity*.9})`;
      dedCtx.fill();
      dedCtx.beginPath();
      dedCtx.arc(n.x,n.y,n.r+Math.sin(n.pulse)*2,0,Math.PI*2);
      dedCtx.strokeStyle=`rgba(212,175,55,${n.opacity*.65})`;
      dedCtx.lineWidth=1.2; dedCtx.stroke();
      dedCtx.font=`600 ${Math.max(9,Math.min(11,n.r*.28))}px 'Josefin Sans',sans-serif`;
      dedCtx.fillStyle=`rgba(212,175,55,${n.opacity})`;
      dedCtx.textAlign='center';
      dedCtx.fillText(n.label, n.x, n.y+4);
    });

    if(deductionActive) dedAnimFrame = requestAnimationFrame(dedDraw);
  }
  cancelAnimationFrame(dedAnimFrame);
  dedDraw();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHERLOCK SPEECH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHERLOCK_LINES = {
  hubQuotes:[
    'Every object in this palace holds a memory. Every memory holds a truth.',
    'I never guess. It is a capital mistake to theorize before one has data.',
    'You see, but you do not observe. The distinction is clear.',
    'The world is full of obvious things which nobody by any chance ever observes.'
  ],
  bakerEnter:[
    'Welcome to 221B. Everything here has a story â€” if you know how to read it.',
    'My desk, my violin, my chemicals â€” each one a portal to another case.'
  ],
  deductionStart:[
    'Eliminate all other factors, and the one which remains must be the truth.',
    'Data! Data! Data! I cannot make bricks without clay.',
    'See how the evidence arranges itself. The connections are there, waiting.'
  ],
  deductionEnd:[
    'The fog clears. The answer sharpens.',
    'Elementary â€” when you see it from the correct angle.'
  ],
  caseEnter:[
    'The game is afoot. Every portal leads deeper into the truth.',
    'You stand at the threshold of the mind. Choose where to begin.',
    'Observe. Deduce. Each chamber holds a different piece of the puzzle.',
    'I have already formed a theory. Let us see if you reach the same conclusion.'
  ],
  evidenceBoard:[
    'Each piece of evidence is a thread. Pull the right one and the whole web unravels.',
    'The fingerprints did not lie. They never do.'
  ],
  suspects:[
    'Study each face. A man\'s history is written in his posture, his eyes, his shoes.',
    'The suspect ring. One of them holds the answer â€” can you see which?'
  ]
};

let speechTimer = null;
function sherlockSpeak(category) {
  clearTimeout(speechTimer);
  const lines = SHERLOCK_LINES[category];
  if(!lines) return;
  const line = lines[Math.floor(Math.random()*lines.length)];
  const el = document.getElementById('sherlock-speech');
  const txt = document.getElementById('speech-text');
  el.classList.remove('show');
  setTimeout(()=>{
    txt.textContent = line;
    el.classList.add('show');
    speechTimer = setTimeout(()=>el.classList.remove('show'), 6000);
  },300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PORTAL NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PORTALS = [
  {label:'CASE FILES', icon:'ğŸ“', sub:'', action:()=>openCaseFiles()},
  {label:'EVIDENCE',   icon:'ğŸ”', sub:'red string', action:()=>openEvidence()},
  {label:'SUSPECTS',   icon:'ğŸ‘¤', sub:'profile ring', action:()=>openSuspects()},
  {label:'TIMELINE',   icon:'â±', sub:'1963', action:()=>openTimeline()},
  {label:'221B',       icon:'ğŸ ', sub:'baker st', action:()=>open221B()},
];

function buildPortalLabels() {
  const container = document.getElementById('portal-labels');
  container.innerHTML = '';
  PORTALS.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'portal-label hoverable';
    div.id = 'pl-' + p.label.toLowerCase().replace(/\s/g,'-');
    // Initial fallback positions (will be overridden by 3D projection)
    const fallbacks = [
      {x:'50%',y:'22%'}, {x:'82%',y:'42%'},
      {x:'72%',y:'74%'}, {x:'28%',y:'74%'}, {x:'18%',y:'42%'}
    ];
    div.style.left = fallbacks[i].x;
    div.style.top  = fallbacks[i].y;

    const subLabel = (i===0 && activeCase) ? `<span class="pl-sub">${activeCase.title}</span>` : (p.sub ? `<span class="pl-sub">${p.sub}</span>` : '');
    div.innerHTML = `<div class="pl-ring"><span class="pl-icon">${p.icon}</span></div><span class="pl-name">${p.label}</span>${subLabel}`;
    div.addEventListener('click', ()=>{
      div.style.transform='translate(-50%,-50%) scale(1.12)';
      setTimeout(()=>div.style.transform='translate(-50%,-50%) scale(1)',300);
      p.action();
    });

    // 3D tilt on mouse move
    div.addEventListener('mousemove', e=>{
      const rect = div.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const dx = (e.clientX - cx) / (rect.width/2);
      const dy = (e.clientY - cy) / (rect.height/2);
      div.style.transform = `translate(-50%,-50%) perspective(500px) rotateY(${dx*8}deg) rotateX(${-dy*6}deg) scale(1.04)`;
    });
    div.addEventListener('mouseleave', ()=>{
      div.style.transform = 'translate(-50%,-50%) scale(1)';
      div.style.transition = 'transform .4s var(--ease), opacity .5s, background .3s, border-color .3s';
    });

    container.appendChild(div);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CASE FILES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CASES = [
  {
    id:'gtr', title:'The Great Train Robbery', year:'1963',
    chapters:[
      {num:'I',title:'The Night Everything Changed',text:'Shortly after <span class="ch-hl">3 o\'clock in the morning</span> on 8th August 1963, the Glasgow-to-London mail train halted at a tampered signal in <span class="ch-hl">Buckinghamshire</span>. Fifteen men had rehearsed this moment for months. They were about to commit the largest cash robbery in British history.',bg:'#010a14'},
      {num:'II',title:'The Signal at Bridego',text:'A gang member climbed the lineside signal post and <span class="ch-hl">replaced the green light with a battery-powered red lamp</span>, forcing driver Jack Mills to halt at <span class="ch-hl">Bridego Railway Bridge</span>. The technical knowledge required pointed to inside expertise.',bg:'#0a0408'},
      {num:'III',title:'120 Bags in Twenty Minutes',text:'In near-total darkness, the gang formed a human chain down the embankment. In just <span class="ch-hl">fifteen minutes</span>, they transferred <span class="ch-hl">120 mailbags</span> containing approximately <span class="ch-hl">Â£2.6 million</span> in used banknotes into waiting lorries.',bg:'#040a04'},
      {num:'IV',title:'Leatherslade Farm',text:'The lorries drove to <span class="ch-hl">Leatherslade Farm</span> in Oakley, Buckinghamshire. Police discovered the farm within weeks. A <span class="ch-hl">ketchup bottle, a Monopoly board</span>, and vehicle surfaces yielded the fingerprints that broke the case.',bg:'#080a04'},
      {num:'V',title:'Scotland Yard Closes In',text:'Detective Superintendent <span class="ch-hl">Tommy Butler</span> dedicated years to the pursuit. By 1964, twelve men stood trial at Aylesbury Assizes, receiving sentences of <span class="ch-hl">25 to 30 years</span>. One question remains: who truly orchestrated it?',bg:'#08040e'},
    ],
    suspects:[
      {id:'reynolds',name:'Bruce Reynolds',role:'THE MASTERMIND',bio:'The principal architect of the operation. Reynolds orchestrated months of preparation, assigned roles, and designed the signal manipulation. He evaded capture until 1968.',verdict:'Principal architect. Fingerprints at Leatherslade. Convicted 1969.',portrait:buildPortraitSVG('detective','Bruce Reynolds','MASTERMIND',0x1a1a2a)},
      {id:'biggs',name:'Ronnie Biggs',role:'THE ACCOMPLICE',bio:'Recruited late, Biggs played a peripheral role. His legendary status came from his dramatic 1965 escape from Wandsworth Prison.',verdict:'Peripheral role. More famous for the escape than the crime.',portrait:buildPortraitSVG('casual','Ronnie Biggs','ACCOMPLICE',0x1a1010)},
      {id:'edwards',name:'Buster Edwards',role:'THE FINANCIER',bio:'A key figure in financing and logistics. Edwards turned himself in voluntarily after years on the run.',verdict:'Key financier. Voluntary surrender 1966. Jailed 15 years.',portrait:buildPortraitSVG('smart','Buster Edwards','FINANCIER',0x0a1a1a)},
      {id:'goody',name:'Gordon Goody',role:'THE ORGANISER',bio:'A capable operational organiser on the night of the robbery. Convicted at Aylesbury and sentenced to 25 years.',verdict:'Convicted. 25 years. Shoe evidence was key.',portrait:buildPortraitSVG('sharp','Gordon Goody','ORGANISER',0x1a1008)},
      {id:'unknown',name:'???',role:'THE UNKNOWN',bio:'One or more individuals who participated in financing or planning and were never identified.',verdict:'Identity unknown. Still unresolved.',portrait:buildUnknownPortrait()},
    ],
    deductionQ:'Who was the true architect of the Great Train Robbery?',
    verdicts:{
      reynolds:{v:'Correct Deduction.',e:'<span class="hl">Bruce Reynolds</span> was the principal architect.',c:'"The criminal, like the detective, must possess above all one quality â€” the capacity to plan." â€” Holmes'},
      biggs:{v:'Partially Right.',e:'The mastermind was <span class="hl">Bruce Reynolds</span>.',c:'"It is a capital mistake to theorize before one has data." â€” Holmes'},
      edwards:{v:'A Credible Theory.',e:'Reynolds coordinated the entire operation. Edwards\' role was significant but subordinate.',c:'"You have been in Afghanistan, I perceive." â€” Holmes'},
      goody:{v:'Close, But Incomplete.',e:'The strategic vision originated with <span class="hl">Bruce Reynolds</span>.',c:'"When you eliminate the impossible..." â€” Holmes'},
      unknown:{v:'The Open Question.',e:'While <span class="hl">Bruce Reynolds</span> is identified as principal architect, inside railway knowledge remains unexplained.',c:'"There is nothing more deceptive than an obvious fact." â€” Holmes'}
    }
  },
  {
    id:'band', title:'The Speckled Band', year:'1892',
    chapters:[
      {num:'I',title:'A Lady in Distress',text:'Before eight o\'clock in the morning a young woman arrives at Baker Street, pale and trembling. <span class="ch-hl">Helen Stoner</span> tells Holmes she fears mortal danger â€” just as her twin sister Julia died mysteriously, her dying words: <span class="ch-hl">"The speckled band!"</span>',bg:'#0e0810'},
      {num:'II',title:'The Estate at Stoke Moran',text:'Holmes notes: the beds <span class="ch-hl">bolted to the floor</span>, the ventilator connecting two rooms, the dummy bell-rope hanging from a <span class="ch-hl">hook above the bed</span>. These are not features of comfort.',bg:'#0a080e'},
      {num:'III',title:'The Doctor\'s Animals',text:'Roylott keeps exotic animals â€” a <span class="ch-hl">cheetah and a baboon</span>. Holmes deduces the true weapon lies not in the open, but concealed within the estate\'s walls.',bg:'#0c0a08'},
      {num:'IV',title:'A Night Watch',text:'Holmes and Watson spend the night in Julia\'s room in total darkness. A soft hissing sound. Holmes strikes furiously. Moments later a terrible cry rings out â€” <span class="ch-hl">Dr Roylott is dead.</span>',bg:'#050510'},
      {num:'V',title:'The Solution Illuminated',text:'The weapon: a <span class="ch-hl">swamp adder</span>, the deadliest snake in India. Trained to travel through the ventilator and down the bell-rope. <span class="ch-hl">His own creature turned upon him.</span>',bg:'#080a12'},
    ],
    suspects:[
      {id:'roylott',name:'Dr Grimesby Roylott',role:'THE STEPFATHER',bio:'Violent, cunning, recently returned from India. Roylott had motive â€” the inheritance clause â€” and means.',verdict:'The murderer. His own trained serpent killed him.',portrait:buildPortraitSVG('detective','Dr Roylott','STEPFATHER',0x2a1808)},
      {id:'helen',name:'Helen Stoner',role:'THE CLIENT',bio:'The surviving stepdaughter who sought Holmes in desperation.',verdict:'The victim â€” innocent. Her courage saved her life.',portrait:buildPortraitSVG('casual','Helen Stoner','CLIENT',0x081828)},
      {id:'julia',name:'Julia Stoner',role:'THE DECEASED',bio:'Helen\'s twin sister whose cryptic dying words broke the cipher.',verdict:'The first victim. Her dying words broke the cipher.',portrait:buildPortraitSVG('smart','Julia Stoner','DECEASED',0x180828)},
      {id:'servants',name:'The Household',role:'THE STAFF',bio:'Roylott\'s sparse household at Stoke Moran.',verdict:'Innocent. Holmes ruled out all household staff.',portrait:buildPortraitSVG('sharp','The Household','STAFF',0x181810)},
    ],
    deductionQ:'Who killed Julia Stoner â€” and with what unusual method?',
    verdicts:{
      roylott:{v:'Precisely Correct.',e:'<span class="hl">Dr Grimesby Roylott</span> trained a deadly swamp adder to travel through the ventilator and strike the occupant.',c:'"When a doctor does go wrong he is the first of criminals." â€” Holmes'},
      helen:{v:'Incorrect.',e:'Helen Stoner was the intended next victim. The real murderer was <span class="hl">Dr Roylott</span>.',c:'"Violence does, in truth, recoil upon the violent." â€” Holmes'},
      julia:{v:'Impossible.',e:'Julia was the first victim. <span class="hl">Dr Roylott</span> was responsible.',c:'"It is a capital mistake to theorize before one has data." â€” Holmes'},
      servants:{v:'Incorrect.',e:'The answer lay in the architecture and <span class="hl">Dr Roylott\'s</span> exotic animals.',c:'"There is nothing more deceptive than an obvious fact." â€” Holmes'},
    }
  },
  {
    id:'hound', title:'The Hound of the Baskervilles', year:'1902',
    chapters:[
      {num:'I',title:'The Curse of the Baskervilles',text:'Dr Mortimer arrives with an ancient manuscript describing a <span class="ch-hl">spectral hound</span>. Sir Charles Baskerville has been found dead, his face frozen in terror. <span class="ch-hl">Enormous footprints of a gigantic hound</span> were found nearby.',bg:'#060e06'},
      {num:'II',title:'The Heir Returns',text:'Sir Henry Baskerville arrives from Canada. He receives threatening letters and discovers one of his new boots stolen. Holmes notes: someone in London is watching him.',bg:'#08100a'},
      {num:'III',title:'The Grimpen Mire',text:'A local naturalist, <span class="ch-hl">Jack Stapleton</span>, seems suspiciously knowledgeable about the moor. At night, a howling cry echoes across the darkness of the <span class="ch-hl">Grimpen Mire</span>.',bg:'#040e04'},
      {num:'IV',title:'The Hound Revealed',text:'The stolen boot was used to give the hound a scent. On a foggy night, the hound is released â€” <span class="ch-hl">its jaws and muzzle outlined with a ghastly phosphorescent light.</span>',bg:'#040c08'},
      {num:'V',title:'The True Identity',text:'Stapleton is exposed as <span class="ch-hl">Rodger Baskerville</span>. He had painted the hound with <span class="ch-hl">phosphorus</span> to create the supernatural illusion. He fled into the Grimpen Mire and was never seen again.',bg:'#060c04'},
    ],
    suspects:[
      {id:'stapleton',name:'Jack Stapleton',role:'THE NATURALIST',bio:'A local naturalist â€” later revealed to be Rodger Baskerville, the illegitimate heir. Cold, calculating.',verdict:'The villain. Drowned in the Grimpen Mire.',portrait:buildPortraitSVG('detective','Jack Stapleton','NATURALIST',0x0a1a08)},
      {id:'barrymore',name:'Barrymore',role:'THE BUTLER',bio:'Observed sending secret signals with a candle â€” later revealed to be aiding an escaped convict, his own brother-in-law.',verdict:'Innocent. His secrecy concealed a family affair.',portrait:buildPortraitSVG('sharp','Barrymore','BUTLER',0x1a1820)},
      {id:'henry',name:'Sir Henry Baskerville',role:'THE HEIR',bio:'The Canadian heir who inherited the cursed estate. The target of Stapleton\'s scheme.',verdict:'The intended victim. Survived.',portrait:buildPortraitSVG('smart','Sir Henry','THE HEIR',0x1a1008)},
      {id:'mortimer',name:'Dr Mortimer',role:'THE DOCTOR',bio:'The local physician who brought the case to Holmes.',verdict:'Innocent and reliable.',portrait:buildPortraitSVG('casual','Dr Mortimer','DOCTOR',0x181020)},
    ],
    deductionQ:'Who unleashed the hound â€” and what was the supernatural secret?',
    verdicts:{
      stapleton:{v:'Exceptional Deduction.',e:'<span class="hl">Jack Stapleton</span> â€” Rodger Baskerville in disguise â€” used a hound coated in phosphorus to create a supernatural appearance.',c:'"The world is full of obvious things which nobody by any chance ever observes." â€” Holmes'},
      barrymore:{v:'A Red Herring.',e:'Barrymore\'s signals were cover for aiding an escaped convict. <span class="hl">Jack Stapleton</span> was the true villain.',c:'"There is nothing more deceptive than an obvious fact." â€” Holmes'},
      henry:{v:'Quite Wrong.',e:'Sir Henry was the victim. <span class="hl">Jack Stapleton</span> â€” the true Baskerville heir â€” orchestrated the scheme.',c:'"When you have eliminated the impossible, whatever remains must be the truth." â€” Holmes'},
      mortimer:{v:'Incorrect.',e:'The villain was <span class="hl">Jack Stapleton</span> â€” whose phosphorus-painted hound and false identity made him the boldest criminal Holmes encountered.',c:'"It is a capital mistake to theorize before one has data." â€” Holmes'},
    }
  }
];

let activeCase = null, activeCaseChapter = 0;

function openCaseFiles() {
  if (currentPhase === 'mind-palace' && activeCase) {
    buildChapters();
    showScreen('s-story');
    sherlockSpeak('hubQuotes');
    return;
  }
  const wipe = document.getElementById('scene-wipe');
  wipe.classList.add('in');
  setTimeout(() => {
    currentPhase = 'case-sel';
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
    document.getElementById('hub-title')?.classList.remove('show');
    document.querySelectorAll('.portal-label').forEach(l => l.classList.remove('show'));
    document.getElementById('three-canvas').style.display = 'none';
    document.getElementById('case-sel-canvas').style.display = 'block';
    initCaseSelection();
    document.getElementById('case-sel-title').classList.add('show');
    document.getElementById('case-sel-hint').style.opacity = '1';
    wipe.classList.remove('in'); wipe.classList.add('out');
    setTimeout(() => wipe.classList.remove('out'), 700);
  }, 650);
}

function buildChapters() {
  const s = document.getElementById('s-story');
  s.querySelectorAll('.chapter').forEach(c=>c.remove());
  activeCase.chapters.forEach((ch,i)=>{
    const div = document.createElement('div');
    div.className = 'chapter'+(i===0?' on':'');
    div.id = 'ch'+i;
    div.style.background = ch.bg;
    const isLast = i===activeCase.chapters.length-1;
    const navNext = isLast ? `<button class="btn-wire" onclick="openDeduction()">MAKE YOUR DEDUCTION â†’</button>` : `<button class="btn-wire" onclick="nextChapter()">NEXT â†’</button>`;
    const navPrev = i===0?'':`<button class="btn-wire" onclick="prevChapter()">â† PREV</button>`;
    div.innerHTML = `
      <div class="ch-veil"></div>
      ${buildChapterBG(ch.bg)}
      <div class="ch-content">
        <div class="ch-num">CHAPTER ${ch.num}</div>
        <div class="ch-title">${ch.title}</div>
        <div class="ch-text">${ch.text}</div>
      </div>
      <div class="ch-nav">
        <div class="ch-ctr">${i+1} / ${activeCase.chapters.length}</div>
        ${navPrev}${navNext}
      </div>`;
    s.appendChild(div);
  });
}

function buildChapterBG(bgColor) {
  return `<svg class="ch-bg" viewBox="0 0 1440 900" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
    <rect width="1440" height="900" fill="${bgColor}"/>
    <circle cx="720" cy="200" r="300" fill="rgba(212,175,55,0.03)"/>
    <line x1="0" y1="650" x2="1440" y2="640" stroke="rgba(212,175,55,0.05)" stroke-width="1"/>
    <line x1="0" y1="680" x2="1440" y2="690" stroke="rgba(212,175,55,0.07)" stroke-width="1.5"/>
    <g fill="none" stroke="rgba(212,175,55,0.04)" stroke-width="1">
      ${Array.from({length:12},(_,i)=>`<rect x="${i*130}" y="580" width="100" height="200" rx="2"/>`).join('')}
    </g>
  </svg>`;
}

function nextChapter() {
  if(activeCaseChapter<activeCase.chapters.length-1){
    document.getElementById('ch'+activeCaseChapter).classList.remove('on');
    activeCaseChapter++;
    document.getElementById('ch'+activeCaseChapter).classList.add('on');
  }
}
function prevChapter() {
  if(activeCaseChapter>0){
    document.getElementById('ch'+activeCaseChapter).classList.remove('on');
    activeCaseChapter--;
    document.getElementById('ch'+activeCaseChapter).classList.add('on');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVIDENCE BOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EVIDENCE_ITEMS = [
  {label:'ORDNANCE\nSURVEY MAP',x:.12,y:.22,type:'document'},
  {label:'MODIFIED\nSIGNAL LAMP',x:.35,y:.18,type:'object'},
  {label:'FINGERPRINTS\nMATCHED',x:.58,y:.25,type:'forensic'},
  {label:'LEATHERSLADE\nFARM',x:.78,y:.20,type:'location'},
  {label:'MONOPOLY\nBOARD',x:.22,y:.55,type:'object'},
  {label:'ARMY\nLORRIES',x:.45,y:.60,type:'vehicle'},
  {label:'POLICE\nRADIO SCANNER',x:.68,y:.55,type:'object'},
  {label:'JACK MILLS\nINCIDENT',x:.15,y:.75,type:'person'},
  {label:'Â£2.6M\nINSTER NOTES',x:.85,y:.65,type:'money'},
  {label:'TOMMY\nBUTLER',x:.50,y:.78,type:'detective'},
];

const EV_CONNECTIONS = [[0,1],[1,2],[2,3],[4,5],[5,6],[0,4],[3,8],[2,9],[7,1],[8,5],[9,2]];
let evCanvas, evCtx, evAnimFrame, evSelected=-1, evHoverIdx=-1;

function openEvidence() {
  showScreen('s-evidence');
  sherlockSpeak('evidenceBoard');
  setTimeout(()=>{
    evCanvas = document.getElementById('evidence-canvas');
    evCtx = evCanvas.getContext('2d');
    evCanvas.width = innerWidth; evCanvas.height = innerHeight;
    evCanvas.addEventListener('click', evClick);
    evCanvas.addEventListener('mousemove', evHover);
    drawEvidence();
  }, 50);
}

function getEvPos(item){return{x:item.x*innerWidth,y:item.y*innerHeight};}

function evClick(e){
  const rect=evCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  EVIDENCE_ITEMS.forEach((item,i)=>{
    const p=getEvPos(item);
    if(Math.hypot(mx-p.x,my-p.y)<52){evSelected=evSelected===i?-1:i;drawEvidence();}
  });
}
function evHover(e){
  const rect=evCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let nh=-1;
  EVIDENCE_ITEMS.forEach((item,i)=>{const p=getEvPos(item);if(Math.hypot(mx-p.x,my-p.y)<55)nh=i;});
  if(nh!==evHoverIdx){evHoverIdx=nh;drawEvidence();}
}

const EV_COLORS={document:'#d4af37',object:'#cc8844',forensic:'#4488cc',location:'#44aa44',vehicle:'#cc4444',money:'#aaaaff',detective:'#cc88ff',person:'#ffaaaa'};

function drawEvidence(){
  if(!evCtx) return;
  evCtx.clearRect(0,0,innerWidth,innerHeight);
  evCtx.fillStyle='rgba(18,10,8,0.95)';
  evCtx.fillRect(0,0,innerWidth,innerHeight);
  for(let i=0;i<innerHeight;i+=6){
    evCtx.beginPath();evCtx.moveTo(0,i);evCtx.lineTo(innerWidth,i);
    evCtx.strokeStyle=`rgba(255,200,100,${.005+Math.sin(i*.3)*.003})`;
    evCtx.lineWidth=.5;evCtx.stroke();
  }
  EV_CONNECTIONS.forEach(([a,b])=>{
    const pa=getEvPos(EVIDENCE_ITEMS[a]),pb=getEvPos(EVIDENCE_ITEMS[b]);
    const isSC=evSelected===a||evSelected===b;
    const alpha=isSC?.65:.28;
    evCtx.beginPath();evCtx.moveTo(pa.x,pa.y);evCtx.lineTo(pb.x,pb.y);
    evCtx.strokeStyle=`rgba(180,30,30,${alpha})`;evCtx.lineWidth=isSC?2:1.2;evCtx.stroke();
    if(isSC){
      evCtx.beginPath();evCtx.moveTo(pa.x,pa.y);evCtx.lineTo(pb.x,pb.y);
      evCtx.strokeStyle='rgba(212,175,55,0.18)';evCtx.lineWidth=6;evCtx.stroke();
    }
  });
  EVIDENCE_ITEMS.forEach((item,i)=>{
    const p=getEvPos(item),col=EV_COLORS[item.type]||'#d4af37';
    const isHov=i===evHoverIdx,isSel=i===evSelected,scale=isHov||isSel?1.1:1;
    const glow=evCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,55*scale);
    glow.addColorStop(0,`${col}${Math.round((isHov||isSel?.25:.06)*255).toString(16).padStart(2,'0')}`);
    glow.addColorStop(1,'rgba(0,0,0,0)');
    evCtx.beginPath();evCtx.arc(p.x,p.y,55*scale,0,Math.PI*2);evCtx.fillStyle=glow;evCtx.fill();
    const cw=120*scale,ch2=56*scale;
    evCtx.fillStyle=`rgba(240,228,200,${.9+(isSel?.06:0)})`;
    evCtx.beginPath();evCtx.roundRect(p.x-cw/2,p.y-ch2/2,cw,ch2,3);evCtx.fill();
    evCtx.strokeStyle=isSel?col:'rgba(160,130,80,0.6)';evCtx.lineWidth=isSel?2:1;evCtx.stroke();
    evCtx.beginPath();evCtx.arc(p.x,p.y-ch2/2-1,6,0,Math.PI*2);
    evCtx.fillStyle=isHov||isSel?col:'#cc3333';evCtx.fill();
    const lines=item.label.split('\n');
    evCtx.font=`bold ${Math.round(9.5*scale)}px 'Special Elite',serif`;
    evCtx.fillStyle='#1a1008';evCtx.textAlign='center';
    lines.forEach((ln,li)=>{evCtx.fillText(ln,p.x,p.y-(lines.length-1)*7*scale+li*14*scale);});
  });
  if(evHoverIdx>=0){
    const item=EVIDENCE_ITEMS[evHoverIdx],p=getEvPos(item),col=EV_COLORS[item.type]||'#d4af37';
    evCtx.fillStyle='rgba(4,4,14,0.95)';
    evCtx.beginPath();evCtx.roundRect(p.x-72,p.y+50,144,30,2);evCtx.fill();
    evCtx.strokeStyle=col;evCtx.lineWidth=1;evCtx.stroke();
    evCtx.font=`600 9px 'Josefin Sans',sans-serif`;
    evCtx.fillStyle=col;evCtx.textAlign='center';
    evCtx.fillText('TYPE: '+item.type.toUpperCase(),p.x,p.y+69);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUSPECT RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let suspCanvas, suspCtx, suspAngle=0, suspTargetAngle=0;
let suspDragging=false, suspLastX=0, suspHover=-1, suspAnimFrame2;

function buildPortraitSVG(type,name,role,bodyCol){
  const bc='#'+bodyCol.toString(16).padStart(6,'0');
  const roleColors={detective:'#3a3a5a',casual:'#3a2020',smart:'#1a2a3a',sharp:'#2a3a1a'};
  const bg=roleColors[type]||'#2a2a3a';
  const n=name.replace(/\s/g,'');
  return `<svg viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="bg_${n}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${bg}"/><stop offset="100%" stop-color="#080808"/></linearGradient><radialGradient id="f_${n}" cx="50%" cy="44%" r="52%"><stop offset="0%" stop-color="#c49060"/><stop offset="100%" stop-color="#8a5a30"/></radialGradient></defs>
    <rect width="200" height="260" fill="url(#bg_${n})"/>
    <path d="M40 150 L70 138 L100 134 L130 138 L160 150 L170 260 L30 260Z" fill="${bc}"/>
    <ellipse cx="100" cy="98" rx="38" ry="44" fill="url(#f_${n})"/>
    <ellipse cx="78" cy="96" rx="7" ry="5.5" fill="#ede0cc"/><circle cx="78" cy="96" r="4" fill="#2a1a08"/>
    <ellipse cx="122" cy="96" rx="7" ry="5.5" fill="#ede0cc"/><circle cx="122" cy="96" r="4" fill="#2a1a08"/>
    <path d="M88 108 Q100 114 112 108" stroke="#8a5030" stroke-width="1.8" fill="none"/>
    <rect width="200" height="260" fill="rgba(0,0,0,0.25)"/>
    <rect width="200" height="260" fill="none" stroke="rgba(212,175,55,0.2)" stroke-width="1"/>
    <text x="100" y="255" text-anchor="middle" font-family="'Josefin Sans',sans-serif" font-size="7" fill="rgba(212,175,55,0.6)" letter-spacing="2">${role}</text>
  </svg>`;
}
function buildUnknownPortrait(){
  return `<svg viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
    <rect width="200" height="260" fill="#050505"/>
    <text x="100" y="148" text-anchor="middle" font-family="'Playfair Display',Georgia,serif" font-size="80" fill="rgba(212,175,55,0.55)" font-weight="bold">?</text>
    <rect width="200" height="260" fill="none" stroke="rgba(212,175,55,0.15)" stroke-width="1"/>
    <text x="100" y="255" text-anchor="middle" font-family="'Josefin Sans',sans-serif" font-size="7" fill="rgba(212,175,55,0.4)" letter-spacing="2">IDENTITY UNKNOWN</text>
  </svg>`;
}

function openSuspects(){
  if(!activeCase){activeCase=CASES[0];}
  showScreen('s-suspects');
  sherlockSpeak('suspects');
  setTimeout(initSuspectRing,60);
}

function initSuspectRing(){
  suspCanvas=document.getElementById('suspects-canvas');
  suspCtx=suspCanvas.getContext('2d');
  suspCanvas.width=innerWidth;suspCanvas.height=innerHeight;
  suspCanvas.addEventListener('mousedown',e=>{suspDragging=true;suspLastX=e.clientX});
  window.addEventListener('mouseup',()=>suspDragging=false);
  window.addEventListener('mousemove',e=>{
    if(suspDragging){suspTargetAngle+=((e.clientX-suspLastX)*.008);suspLastX=e.clientX;}
  });
  suspCanvas.addEventListener('click',e=>{if(!suspDragging)suspClick(e)});
  suspCanvas.addEventListener('mousemove',e=>suspMouseMove(e));
  cancelAnimationFrame(suspAnimFrame2);
  drawSuspects();
}

function getSuspectPositions(){
  const cx=innerWidth/2,cy=innerHeight/2,r=Math.min(innerWidth,innerHeight)*.32;
  return activeCase.suspects.map((_,i)=>{
    const a=suspAngle+(i/activeCase.suspects.length)*Math.PI*2-Math.PI*.5;
    const depth=Math.cos(a+Math.PI);
    const scale=.65+depth*.35;
    return{x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r*.4,scale,depth,angle:a,idx:i};
  }).sort((a,b)=>a.depth-b.depth);
}

function suspClick(e){
  const rect=suspCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  [...getSuspectPositions()].reverse().forEach(p=>{
    if(Math.hypot(mx-p.x,my-p.y)<55*p.scale*1.2){openSuspectInfo(p.idx);}
  });
}
function suspMouseMove(e){
  const rect=suspCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let nh=-1;
  getSuspectPositions().reverse().forEach(p=>{
    if(Math.hypot(mx-p.x,my-p.y)<55*p.scale*1.2)nh=p.idx;
  });
  if(nh!==suspHover){suspHover=nh;}
}

function drawSuspects(){
  if(!suspCtx)return;
  suspCtx.clearRect(0,0,innerWidth,innerHeight);
  suspAngle+=(suspTargetAngle-suspAngle)*.08;
  const t=Date.now()*.001;
  const cx=innerWidth/2,cy=innerHeight/2,r=Math.min(innerWidth,innerHeight)*.32;

  // Floor ring
  suspCtx.beginPath();suspCtx.ellipse(cx,cy,r+30,r*.4+12,0,0,Math.PI*2);
  suspCtx.strokeStyle='rgba(212,175,55,0.12)';suspCtx.lineWidth=1;suspCtx.stroke();

  const sp=suspCtx.createRadialGradient(cx,cy-100,0,cx,cy+60,280);
  sp.addColorStop(0,'rgba(212,175,55,0.06)');sp.addColorStop(1,'rgba(0,0,0,0)');
  suspCtx.fillStyle=sp;suspCtx.beginPath();suspCtx.ellipse(cx,cy,300,220,0,0,Math.PI*2);suspCtx.fill();

  getSuspectPositions().forEach(p=>{
    const susp=activeCase.suspects[p.idx],isHov=suspHover===p.idx,sz=110*p.scale;
    if(isHov){
      const spg=suspCtx.createRadialGradient(p.x,p.y-sz,0,p.x,p.y,sz*1.8);
      spg.addColorStop(0,'rgba(212,175,55,0.15)');spg.addColorStop(1,'rgba(0,0,0,0)');
      suspCtx.beginPath();suspCtx.ellipse(p.x,p.y,sz*1.5,sz*.8,0,0,Math.PI*2);
      suspCtx.fillStyle=spg;suspCtx.fill();
    }
    suspCtx.beginPath();suspCtx.ellipse(p.x,p.y+sz*.35,sz*.7,sz*.18,0,0,Math.PI*2);
    suspCtx.fillStyle=`rgba(0,0,0,${.35*p.scale})`;suspCtx.fill();
    suspCtx.save();suspCtx.translate(p.x,p.y);suspCtx.scale(p.scale,p.scale);
    suspCtx.fillStyle=`hsl(240,20%,${12+p.depth*8}%)`;
    suspCtx.beginPath();suspCtx.roundRect(-38,-40,76,100,4);suspCtx.fill();
    suspCtx.beginPath();suspCtx.ellipse(0,-65,26,30,0,0,Math.PI*2);
    suspCtx.fillStyle=`hsl(30,35%,${50+p.depth*10}%)`;suspCtx.fill();
    const na=.4+p.depth*.5+(isHov?.25:0);
    suspCtx.fillStyle=`rgba(212,175,55,${na})`;
    suspCtx.font=`600 ${11+p.scale*3}px 'Josefin Sans',sans-serif`;
    suspCtx.textAlign='center';suspCtx.fillText(susp.name.toUpperCase(),0,80);
    suspCtx.font=`${8+p.scale*2}px 'Josefin Sans',sans-serif`;
    suspCtx.fillStyle=`rgba(255,255,255,${na*.6})`;suspCtx.fillText(susp.role,0,96);
    suspCtx.restore();
  });
  suspAnimFrame2=requestAnimationFrame(drawSuspects);
}

function openSuspectInfo(idx){
  const susp=activeCase.suspects[idx];
  document.getElementById('si-role').textContent=susp.role;
  document.getElementById('si-name').textContent=susp.name;
  document.getElementById('si-portrait').innerHTML=susp.portrait;
  document.getElementById('si-bio').textContent=susp.bio;
  document.getElementById('si-verdict').textContent='âš– '+susp.verdict;
  document.getElementById('susp-info').classList.add('show');
}
function closeSuspectInfo(){document.getElementById('susp-info').classList.remove('show');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRIME TIMELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TIMELINE_EVENTS = [
  {time:'21:00',event:'Train departs Glasgow',detail:'The overnight mail train leaves Glasgow Central loaded with used banknotes.'},
  {time:'23:30',event:'Gang assembles',detail:'Fifteen men gather near Bridego Bridge. Army lorries, walkie-talkies ready.'},
  {time:'00:30',event:'Leatherslade confirmed',detail:'Final radio check between the farm and the team at the bridge.'},
  {time:'02:45',event:'Signal tampered',detail:'The green signal lamp is replaced with a battery-powered red one.'},
  {time:'03:03',event:'Train halts',detail:'The mail train stops at Bridego Railway Bridge. Jack Mills is overpowered.'},
  {time:'03:05',event:'Transfer begins',detail:'120 mailbags passed hand to hand down the embankment in near-total darkness.'},
  {time:'03:27',event:'Transfer complete',detail:'Â£2.6 million loaded onto lorries. The convoy moves toward Leatherslade Farm.'},
  {time:'04:15',event:'Farm arrival',detail:'Bags counted, money divided. Plan: lie low for several days.'},
  {time:'Aug 13',event:'Farm discovered',detail:'Fingerprints from a ketchup bottle and Monopoly board break the case.'},
  {time:'Aug 22',event:'First arrest',detail:'Roger Cordrey arrested with Â£141,000 in cash.'},
  {time:'1964',event:'Aylesbury trial',detail:'Twelve defendants tried. Sentences of 25 to 30 years.'},
  {time:'1968',event:'Reynolds captured',detail:'Mastermind Bruce Reynolds arrested in Torquay.'},
];

function openTimeline(){showScreen('s-timeline');buildTimeline();}
function buildTimeline(){
  const track=document.getElementById('tl-track');
  track.innerHTML='';
  TIMELINE_EVENTS.forEach((ev,i)=>{
    const line=document.createElement('div');line.className='tl-line';track.appendChild(line);
    const card=document.createElement('div');card.className='tl-card';
    card.innerHTML=`<div class="tl-dot"></div><div class="tl-time">${ev.time}</div><div class="tl-event">${ev.event}</div><div class="tl-detail">${ev.detail}</div>`;
    card.style.opacity='0';card.style.transform='translateY(20px)';
    card.style.transition=`opacity .5s var(--ease) ${i*.05}s, transform .5s var(--ease) ${i*.05}s`;
    track.appendChild(card);
    setTimeout(()=>{card.style.opacity='1';card.style.transform='translateY(0)'},60);
  });
  let dragging=false,startX=0,scrollStart=0;
  track.addEventListener('mousedown',e=>{dragging=true;startX=e.pageX;scrollStart=track.scrollLeft;track.style.cursor='grabbing'});
  window.addEventListener('mouseup',()=>{dragging=false;track.style.cursor='grab'});
  window.addEventListener('mousemove',e=>{if(dragging)track.scrollLeft=scrollStart-(e.pageX-startX)});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   221B BAKER STREET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ROOM_OBJECTS=[
  {id:'desk',icon:'ğŸ“‹',label:'DESK',x:'42%',y:'55%',action:openCaseFiles,hint:'Case files'},
  {id:'violin',icon:'ğŸ»',label:'VIOLIN',x:'22%',y:'40%',action:toggleDeductionMode,hint:'Deduction mode'},
  {id:'chem',icon:'âš—ï¸',label:'CHEMISTRY',x:'68%',y:'48%',action:openEvidence,hint:'Evidence analysis'},
  {id:'fire',icon:'ğŸ”¥',label:'FIREPLACE',x:'50%',y:'75%',action:openTimeline,hint:'Crime timeline'},
  {id:'news',icon:'ğŸ“°',label:'NEWSPAPER',x:'78%',y:'62%',action:openSuspects,hint:'Suspect profiles'},
];

function open221B(){showScreen('s-baker');buildBakerRoom();sherlockSpeak('bakerEnter');}
function buildBakerRoom(){
  const room=document.getElementById('baker-room');room.innerHTML='';
  ROOM_OBJECTS.forEach(obj=>{
    const el=document.createElement('div');
    el.className='room-object hoverable';el.id='ro-'+obj.id;
    el.style.left=obj.x;el.style.top=obj.y;
    el.style.position='absolute';el.style.opacity='0';el.style.transform='translate(-50%,-50%)';
    el.innerHTML=`<div class="ro-glow"></div><div style="font-size:2.8em;text-align:center;filter:drop-shadow(0 0 12px rgba(212,175,55,0.5))">${obj.icon}</div><div class="ro-label">${obj.label}</div>`;
    el.addEventListener('click',()=>{el.style.transform='translate(-50%,-50%) scale(1.2)';setTimeout(()=>el.style.transform='translate(-50%,-50%)',300);obj.action();});
    room.appendChild(el);
    setTimeout(()=>{el.classList.add('show');el.style.transition='opacity 0.5s, transform 0.5s';},100*ROOM_OBJECTS.indexOf(obj)+200);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEDUCTION QUIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDeduction(){
  if(!activeCase){activeCase=CASES[0];buildChapters();}
  document.getElementById('ded-question').textContent=activeCase.deductionQ;
  const grid=document.getElementById('ded-grid');grid.innerHTML='';
  activeCase.suspects.forEach(s=>{
    const c=document.createElement('div');c.className='ded-card hoverable';
    c.innerHTML=`<div class="ded-name">${s.name}</div><div class="ded-role">${s.role}</div>`;
    c.onclick=()=>showReveal(s.id);grid.appendChild(c);
  });
  showScreen('s-deduction');
}

function showReveal(suspectId){
  if(!activeCase) return;
  const v=activeCase.verdicts[suspectId]||activeCase.verdicts.unknown;
  document.getElementById('rv-verdict').textContent=v.v;
  document.getElementById('rv-explain').innerHTML=v.e;
  document.getElementById('rv-closing').textContent=v.c;
  showScreen('s-reveal');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentPhase = 'entry';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENTRY HUB â€” 3D SCENE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let entryScene, entryCamera, entryRenderer, entryClock;
let entryObjects={}, entryHovered=null, entryParticles=[];
let entryCamTargetX=0, entryCamTargetY=0, entryCamCurrentX=0, entryCamCurrentY=0;
let entryRaf=null;

function initEntryHub(){
  const canvas=document.getElementById('entry-canvas');
  entryScene=new THREE.Scene();
  entryScene.background=new THREE.Color(0x01010a);
  entryScene.fog=new THREE.FogExp2(0x01010a,0.026);
  entryCamera=new THREE.PerspectiveCamera(58,innerWidth/innerHeight,0.1,500);
  entryCamera.position.set(0,1.2,18);
  entryCamera.lookAt(0,0.5,0);
  entryRenderer=new THREE.WebGLRenderer({canvas,antialias:true});
  entryRenderer.setSize(innerWidth,innerHeight);
  entryRenderer.setPixelRatio(Math.min(devicePixelRatio,2));
  entryRenderer.toneMapping=THREE.ACESFilmicToneMapping;
  entryRenderer.toneMappingExposure=1.2;
  entryClock=new THREE.Clock();

  entryScene.add(new THREE.AmbientLight(0x08080f,0.5));
  const mainLight=new THREE.DirectionalLight(0xd4a060,1.6);mainLight.position.set(-5,12,8);entryScene.add(mainLight);
  const rimLight=new THREE.DirectionalLight(0x2244aa,0.7);rimLight.position.set(8,3,-10);entryScene.add(rimLight);
  const fireGlow=new THREE.PointLight(0xff7722,1.8,22);fireGlow.position.set(-7,-2,4);entryScene.add(fireGlow);window._entryFire=fireGlow;
  const candleA=new THREE.PointLight(0xffbb44,0.9,16);candleA.position.set(3,2,6);entryScene.add(candleA);window._entryCandle=candleA;

  buildEntryFloor();
  buildEntryObjects();
  buildEntryParticles();
  buildEntryRoom();

  canvas.addEventListener('mousemove',onEntryMouseMove);
  canvas.addEventListener('click',onEntryClick);
  document.addEventListener('mousemove',e=>{
    entryCamTargetX=((e.clientX/innerWidth)*2-1)*2.8;
    entryCamTargetY=(-(e.clientY/innerHeight)*2+1)*1.5;
  });
  window.addEventListener('resize',()=>{
    entryCamera.aspect=innerWidth/innerHeight;
    entryCamera.updateProjectionMatrix();
    entryRenderer.setSize(innerWidth,innerHeight);
  });
  entryLoop();
}

function buildEntryFloor(){
  const geo=new THREE.PlaneGeometry(60,60);
  const mat=new THREE.MeshStandardMaterial({color:0x06060e,roughness:0.22,metalness:0.55});
  const floor=new THREE.Mesh(geo,mat);floor.rotation.x=-Math.PI/2;floor.position.y=-4;entryScene.add(floor);

  // Floor grid
  const grid=new THREE.GridHelper(40,20,0xd4af37,0xd4af37);
  grid.material.transparent=true;grid.material.opacity=0.04;grid.position.y=-3.99;entryScene.add(grid);

  const lineGeo=new THREE.PlaneGeometry(14,0.02);
  const lineMat=new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.1});
  const line=new THREE.Mesh(lineGeo,lineMat);line.rotation.x=-Math.PI/2;line.position.set(0,-3.98,0);entryScene.add(line);
}

function buildEntryRoom(){
  const wallMat=new THREE.MeshStandardMaterial({color:0x07070f,roughness:0.9});
  const backWall=new THREE.Mesh(new THREE.PlaneGeometry(60,20),wallMat);
  backWall.position.z=-12;backWall.position.y=6;entryScene.add(backWall);

  const n=200,geo=new THREE.BufferGeometry(),pos=new Float32Array(n*3),vel=[];
  for(let i=0;i<n*3;i+=3){
    pos[i]=(Math.random()-.5)*40;pos[i+1]=(Math.random()-.5)*16;pos[i+2]=(Math.random()-.5)*30;
    vel.push({x:(Math.random()-.5)*.008,y:Math.random()*.012-.004});
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const pts=new THREE.Points(geo,new THREE.PointsMaterial({color:0xd4c090,size:0.08,transparent:true,opacity:0.3,blending:THREE.AdditiveBlending,depthWrite:false}));
  entryScene.add(pts);entryParticles.push({mesh:pts,vel,pos});
}

function buildEntryObjects(){
  // â”€â”€ CASE FILE (left) â”€â”€
  const caseGroup=new THREE.Group();caseGroup.position.set(-5.5,0.2,-2);
  caseGroup.userData={id:'case',baseY:0.2,label:'lbl-case'};entryScene.add(caseGroup);entryObjects.case=caseGroup;
  const folderMat=new THREE.MeshStandardMaterial({color:0x8a4a18,roughness:0.7,metalness:0.1});
  const folderBack=new THREE.Mesh(new THREE.BoxGeometry(3.2,4.2,0.06),folderMat);caseGroup.add(folderBack);
  const coverGroup=new THREE.Group();coverGroup.position.set(-1.6,0,0.03);
  const cover=new THREE.Mesh(new THREE.BoxGeometry(3.2,4.2,0.05),new THREE.MeshStandardMaterial({color:0xa05820,roughness:0.65}));
  cover.position.x=1.6;coverGroup.add(cover);coverGroup.rotation.y=0.28;caseGroup.add(coverGroup);
  for(let i=0;i<4;i++){
    const paper=new THREE.Mesh(new THREE.BoxGeometry(2.9,3.8,0.02),new THREE.MeshStandardMaterial({color:0xf0e8d0,roughness:0.9}));
    paper.position.set((Math.random()-.5)*.15,(Math.random()-.5)*.1,0.04+i*.015);paper.rotation.z=(Math.random()-.5)*.06;caseGroup.add(paper);
  }
  const stampMat=new THREE.MeshBasicMaterial({color:0xcc2222,transparent:true,opacity:0.85});
  const stamp=new THREE.Mesh(new THREE.PlaneGeometry(2.4,0.5),stampMat);stamp.position.set(0,0.8,0.12);caseGroup.add(stamp);
  const aura=new THREE.Mesh(new THREE.SphereGeometry(2.8,16,16),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0,side:THREE.BackSide}));
  caseGroup.add(aura);caseGroup.userData.aura=aura;
  const orbit=new THREE.Mesh(new THREE.TorusGeometry(2.2,0.025,12,64),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.3}));
  orbit.rotation.x=Math.PI*.45;caseGroup.add(orbit);caseGroup.userData.orbit=orbit;

  // â”€â”€ BOOKSHELF (centre) â”€â”€
  const shelfGroup=new THREE.Group();shelfGroup.position.set(0,-0.5,-3.5);
  shelfGroup.userData={id:'shelf',baseY:-0.5,label:'lbl-shop'};entryScene.add(shelfGroup);entryObjects.shelf=shelfGroup;
  const shelfMat=new THREE.MeshStandardMaterial({color:0x3a2010,roughness:0.8,metalness:0.1});
  const plank=new THREE.Mesh(new THREE.BoxGeometry(5.5,0.12,0.9),shelfMat);plank.position.y=-1.4;shelfGroup.add(plank);
  const plank2=new THREE.Mesh(new THREE.BoxGeometry(5.5,0.12,0.9),shelfMat);plank2.position.y=1.5;shelfGroup.add(plank2);
  const sideL=new THREE.Mesh(new THREE.BoxGeometry(0.1,3.2,0.9),shelfMat);sideL.position.set(-2.7,0,0);shelfGroup.add(sideL);
  const sideR=new THREE.Mesh(new THREE.BoxGeometry(0.1,3.2,0.9),shelfMat);sideR.position.set(2.7,0,0);shelfGroup.add(sideR);
  const bookColors=[0x8B1a1a,0x1a4a8B,0x2a7a2a,0x8B6a1a,0x5a1a8B,0x8B3a1a,0x1a6a6a,0xd4af37,0x6B2a0a,0x2a5a2a];
  const bookWidths=[0.35,0.45,0.3,0.5,0.38,0.42,0.36,0.28,0.44,0.32];
  let bx=-2.2;
  for(let i=0;i<10;i++){
    const bw=bookWidths[i],bh=2.2+Math.random()*.6;
    const book=new THREE.Mesh(new THREE.BoxGeometry(bw,bh,0.7),new THREE.MeshStandardMaterial({color:bookColors[i],roughness:0.8}));
    book.position.set(bx+bw/2,-1.4+bh/2+0.06,0);book.rotation.z=(Math.random()-.5)*.04;shelfGroup.add(book);
    const spine=new THREE.Mesh(new THREE.BoxGeometry(0.025,bh*.6,0.72),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.5}));
    spine.position.set(bx+bw/2,-1.4+bh/2+0.06,0.01);shelfGroup.add(spine);bx+=bw+0.04;
  }
  const shelfAura=new THREE.Mesh(new THREE.SphereGeometry(3.5,16,16),new THREE.MeshBasicMaterial({color:0xd4c060,transparent:true,opacity:0,side:THREE.BackSide}));
  shelfGroup.add(shelfAura);shelfGroup.userData.aura=shelfAura;
  const shelfOrbit=new THREE.Mesh(new THREE.TorusGeometry(3.0,0.022,12,64),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.22}));
  shelfOrbit.rotation.x=Math.PI*.4;shelfGroup.add(shelfOrbit);shelfGroup.userData.orbit=shelfOrbit;

  // â”€â”€ MAGIC LANTERN / PROJECTOR (right) â”€â”€
  const projGroup=new THREE.Group();projGroup.position.set(5.5,-0.3,-1.5);
  projGroup.userData={id:'projector',baseY:-0.3,label:'lbl-watch'};entryScene.add(projGroup);entryObjects.projector=projGroup;
  const brassMat=new THREE.MeshStandardMaterial({color:0xb8860b,roughness:0.35,metalness:0.8});
  const darkMat=new THREE.MeshStandardMaterial({color:0x1a1a08,roughness:0.6});
  const body=new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.9,2.4,24),brassMat);projGroup.add(body);
  const lens=new THREE.Mesh(new THREE.CylinderGeometry(0.38,0.42,0.9,20),brassMat);lens.rotation.z=Math.PI/2;lens.position.set(-1.2,0,0);projGroup.add(lens);
  const lensGlass=new THREE.Mesh(new THREE.CircleGeometry(0.35,24),new THREE.MeshBasicMaterial({color:0xffffcc,transparent:true,opacity:0.15}));
  lensGlass.rotation.y=Math.PI/2;lensGlass.position.set(-1.66,0,0);projGroup.add(lensGlass);projGroup.userData.lensGlass=lensGlass;
  const base=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.18,1.4),darkMat);base.position.y=-1.3;projGroup.add(base);
  const chimney=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.2,0.6,12),brassMat);chimney.position.y=1.5;projGroup.add(chimney);
  const beam=new THREE.Mesh(new THREE.ConeGeometry(2.5,6,24,1,true),new THREE.MeshBasicMaterial({color:0xfff8e0,transparent:true,opacity:0,side:THREE.BackSide}));
  beam.rotation.z=Math.PI/2;beam.position.set(-4.2,0,0);projGroup.add(beam);projGroup.userData.beam=beam;
  const projAura=new THREE.Mesh(new THREE.SphereGeometry(2.8,16,16),new THREE.MeshBasicMaterial({color:0xffee88,transparent:true,opacity:0,side:THREE.BackSide}));
  projGroup.add(projAura);projGroup.userData.aura=projAura;
  const projOrbit=new THREE.Mesh(new THREE.TorusGeometry(2.4,0.022,12,64),new THREE.MeshBasicMaterial({color:0xffe844,transparent:true,opacity:0.22}));
  projOrbit.rotation.x=Math.PI*.42;projGroup.add(projOrbit);projGroup.userData.orbit=projOrbit;
}

function buildEntryParticles(){
  const n=120,geo=new THREE.BufferGeometry(),pos=new Float32Array(n*3),vel=[];
  for(let i=0;i<n*3;i+=3){
    pos[i]=(Math.random()-.5)*30;pos[i+1]=-3.5+Math.random()*1.5;pos[i+2]=(Math.random()-.5)*20;
    vel.push({x:(Math.random()-.5)*.005,y:0});
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const fogPts=new THREE.Points(geo,new THREE.PointsMaterial({color:0x8888aa,size:0.35,transparent:true,opacity:0.18,blending:THREE.AdditiveBlending,depthWrite:false}));
  entryScene.add(fogPts);entryParticles.push({mesh:fogPts,vel,pos});
}

const entryRaycaster=new THREE.Raycaster(),entryMouse=new THREE.Vector2();
function getEntryInteractables(){return[entryObjects.case,entryObjects.shelf,entryObjects.projector];}

function onEntryMouseMove(e){
  entryMouse.x=(e.clientX/innerWidth)*2-1;entryMouse.y=-(e.clientY/innerHeight)*2+1;
  entryRaycaster.setFromCamera(entryMouse,entryCamera);
  let hit=null;
  getEntryInteractables().forEach(obj=>{
    const intersects=entryRaycaster.intersectObjects(obj.children,true);
    if(intersects.length>0)hit=obj.userData.id;
  });
  if(hit!==entryHovered){entryHovered=hit;updateEntryHover();}
}

function onEntryClick(e){
  entryRaycaster.setFromCamera(entryMouse,entryCamera);
  let hit=null;
  getEntryInteractables().forEach(obj=>{
    const intersects=entryRaycaster.intersectObjects(obj.children,true);
    if(intersects.length>0)hit=obj.userData.id;
  });
  if(hit==='case')activateCase();
  if(hit==='shelf')activateShop();
  if(hit==='projector')activateProjector();
}

function updateEntryHover(){
  ['case','shelf','projector'].forEach(id=>{
    const obj=entryObjects[id],isHov=id===entryHovered;
    if(obj.userData.aura)gsap.to(obj.userData.aura.material,{opacity:isHov?.15:0,duration:0.5});
    if(obj.userData.orbit)gsap.to(obj.userData.orbit.material,{opacity:isHov?.85:.22,duration:0.4});
    gsap.to(obj.position,{y:obj.userData.baseY+(isHov?.4:0),duration:0.5,ease:'power2.out'});
    if(id==='projector'&&obj.userData.beam)gsap.to(obj.userData.beam.material,{opacity:isHov?.08:0,duration:0.6});
    if(id==='projector'&&obj.userData.lensGlass)gsap.to(obj.userData.lensGlass.material,{opacity:isHov?.65:.15,duration:0.5});
    const lbl=document.getElementById('lbl-'+id);
    if(lbl){lbl.classList.add('show');lbl.classList.toggle('hovered',isHov);}
  });
  document.getElementById('entry-canvas').style.cursor=entryHovered?'pointer':'default';
}

function worldToScreen(pos,cam){
  const v=pos.clone().project(cam);
  return{x:(v.x*.5+.5)*innerWidth,y:(-v.y*.5+.5)*innerHeight};
}

function updateEntryLabels(){
  const labelOffsets={case:{dx:0,dy:130},shelf:{dx:0,dy:170},projector:{dx:0,dy:110}};
  ['case','shelf','projector'].forEach(id=>{
    const obj=entryObjects[id],lbl=document.getElementById('lbl-'+id);
    if(!lbl||!obj)return;
    const worldPos=new THREE.Vector3();obj.getWorldPosition(worldPos);
    const screen=worldToScreen(worldPos,entryCamera);
    const off=labelOffsets[id];
    lbl.style.left=(screen.x+off.dx)+'px';
    lbl.style.top=(screen.y+off.dy)+'px';
    lbl.style.transform='translate(-50%, 0)';
  });
}

function entryLoop(){
  if(currentPhase!=='entry')return;
  entryRaf=requestAnimationFrame(entryLoop);
  const t=entryClock.getElapsedTime();
  entryCamCurrentX+=(entryCamTargetX-entryCamCurrentX)*.045;
  entryCamCurrentY+=(entryCamTargetY-entryCamCurrentY)*.045;
  entryCamera.position.x=entryCamCurrentX;
  entryCamera.position.y=1.2+entryCamCurrentY*.4;
  entryCamera.lookAt(0,0.5,0);

  ['case','shelf','projector'].forEach((id,i)=>{
    const obj=entryObjects[id];if(!obj)return;
    const isHov=id===entryHovered;
    obj.position.y=obj.userData.baseY+Math.sin(t*.7+i*1.2)*.08+(isHov?.35:0);
    if(id==='case'){
      obj.rotation.y=Math.sin(t*.4)*.06+(isHov?.1:0);
      // Subtle tilt when hovered
      if(isHov) obj.rotation.x=Math.sin(t*1.2)*.03;
    }
    if(id==='shelf')obj.rotation.y=Math.sin(t*.35+1)*.04;
    if(id==='projector'){
      obj.rotation.y=Math.sin(t*.45+2)*.05;
      if(isHov&&obj.userData.lensGlass)obj.userData.lensGlass.material.opacity=0.4+Math.sin(t*3)*.18;
    }
    if(obj.userData.orbit)obj.userData.orbit.rotation.z=t*.3*(i%2===0?1:-1);

    // Depth blur on non-hovered objects (CSS filter via userData)
    const blurStrength = entryHovered && !isHov ? '2px' : '0px';
    // We can't do per-object blur in THREE.js easily, skip
  });

  if(window._entryFire)window._entryFire.intensity=1.6+Math.sin(t*8.2)*.3+Math.sin(t*13.5)*.15;
  if(window._entryCandle)window._entryCandle.intensity=0.8+Math.sin(t*5.1)*.15;

  entryParticles.forEach(ps=>{
    const p=ps.mesh.geometry.attributes.position.array;
    ps.vel.forEach((v,i)=>{
      const x=i*3;p[x]+=v.x;p[x+1]+=v.y;
      if(Math.abs(p[x])>15)p[x]*=-.95;
      if(p[x+1]>-2){p[x+1]=-4+Math.random();}
    });
    ps.mesh.geometry.attributes.position.needsUpdate=true;
  });

  updateEntryLabels();
  entryRenderer.render(entryScene,entryCamera);
}

function activateCase(){
  entryHovered=null;
  const obj=entryObjects.case;
  const targetPos=new THREE.Vector3();obj.getWorldPosition(targetPos);
  gsap.to(obj.userData.aura.material,{opacity:0.4,duration:0.3});
  obj.children.forEach((child,i)=>{
    if(child.geometry)gsap.to(child.rotation,{z:child.rotation.z+(Math.random()-.5)*.12,duration:0.25,delay:i*.04});
  });
  gsap.to(entryCamera.position,{x:targetPos.x*.35,y:targetPos.y+0.8,z:4.5,duration:1.5,ease:'power3.inOut',onComplete:()=>transitionToCaseSelection()});
  gsap.to(entryCamera.rotation,{x:-0.06,duration:1.5,ease:'power3.inOut'});
  ['shelf','projector'].forEach(id=>{gsap.to(entryObjects[id].position,{z:entryObjects[id].position.z-4,duration:1.0,ease:'power2.in'});});
}

function activateShop(){
  const obj=entryObjects.shelf;
  gsap.to(obj.userData.aura.material,{opacity:0.3,duration:0.2,yoyo:true,repeat:1});
  gsap.to(obj.position,{y:obj.userData.baseY+0.8,duration:0.5,ease:'back.out(1.5)',yoyo:true,repeat:1});
  if(obj.userData.orbit){gsap.to(obj.userData.orbit.material,{opacity:1.0,duration:0.3});gsap.to(obj.userData.orbit.rotation,{z:obj.userData.orbit.rotation.z+Math.PI*2,duration:0.8,ease:'power2.in'});}
  let bookIdx=0;
  obj.children.forEach((child,i)=>{
    if(child.isMesh&&child.geometry.type==='BoxGeometry'&&child.geometry.parameters&&child.geometry.parameters.height>0.5){
      const delay=bookIdx*55,dir=bookIdx%2===0?1:-1;
      setTimeout(()=>{
        gsap.to(child.position,{y:child.position.y+0.45*dir,duration:0.25,yoyo:true,repeat:1,ease:'power1.out'});
        gsap.to(child.rotation,{z:child.rotation.z+0.12*dir,duration:0.25,yoyo:true,repeat:1});
      },delay);bookIdx++;
    }
  });
  setTimeout(()=>{gsap.to(obj.userData.aura.material,{opacity:0,duration:0.6});window.open('https://www.amazon.com/s?k=sherlock+holmes+books+collectibles','_blank');},1100);
}

function activateProjector(){
  const obj=entryObjects.projector;
  gsap.to(obj.position,{x:obj.position.x+0.04,duration:0.06,yoyo:true,repeat:8});
  setTimeout(()=>{
    if(obj.userData.lensGlass){gsap.to(obj.userData.lensGlass.material,{opacity:0.3,duration:0.1,yoyo:true,repeat:3});gsap.to(obj.userData.lensGlass.material,{opacity:1.0,duration:0.4,delay:0.4});}
  },400);
  setTimeout(()=>{
    if(obj.userData.beam)gsap.to(obj.userData.beam.material,{opacity:0.22,duration:0.6,ease:'power2.in'});
    gsap.to(obj.userData.aura.material,{opacity:0.25,duration:0.5});
    if(window._entryFire)gsap.to(window._entryFire,{intensity:3.5,duration:0.4,yoyo:true,repeat:1});
  },700);
  setTimeout(()=>{
    gsap.to(obj.userData.beam?.material||{},{opacity:0,duration:1.5,delay:0.3});
    gsap.to(obj.userData.aura.material,{opacity:0,duration:1.2});
    window.open('https://www.youtube.com/results?search_query=sherlock+holmes+best+scenes+cinematic','_blank');
  },1200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSITION: ENTRY â†’ CASE SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function transitionToCaseSelection(){
  const wipe=document.getElementById('scene-wipe');
  wipe.classList.add('in');
  setTimeout(()=>{
    currentPhase='case-sel';
    cancelAnimationFrame(entryRaf);
    document.getElementById('entry-canvas').style.display='none';
    document.getElementById('entry-title').classList.remove('show');
    document.getElementById('entry-bottom').classList.remove('show');
    ['lbl-case','lbl-shop','lbl-watch'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('show');});
    document.getElementById('case-sel-canvas').style.display='block';
    initCaseSelection();
    wipe.classList.remove('in');wipe.classList.add('out');
    document.getElementById('case-sel-title').classList.add('show');
    document.getElementById('case-sel-hint').style.opacity='1';
    setTimeout(()=>wipe.classList.remove('out'),700);
  },650);
}

function backToEntry(){
  const wipe=document.getElementById('scene-wipe');wipe.classList.add('in');
  setTimeout(()=>{
    currentPhase='entry';cancelAnimationFrame(caseSelRaf);
    document.getElementById('case-sel-canvas').style.display='none';
    document.getElementById('case-sel-title').classList.remove('show');
    document.getElementById('case-sel-hint').style.opacity='0';
    ['cl-gtr','cl-band','cl-hound'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('show');});
    document.getElementById('entry-canvas').style.display='block';
    document.getElementById('entry-title').classList.add('show');
    document.getElementById('entry-bottom').classList.add('show');
    entryCamera.position.set(0,1.2,18);entryCamera.lookAt(0,0.5,0);entryCamera.rotation.set(0,0,0);
    entryLoop();
    setTimeout(()=>{'lbl-case lbl-shop lbl-watch'.split(' ').forEach((id,i)=>setTimeout(()=>{const el=document.getElementById(id);if(el)el.classList.add('show');},i*150));},300);
    wipe.classList.remove('in');wipe.classList.add('out');setTimeout(()=>wipe.classList.remove('out'),700);
  },650);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CASE SELECTION â€” 3D SCENE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let caseSelScene,caseSelCamera,caseSelRenderer,caseSelClock;
let caseSelObjects=[],caseSelHovered=-1,caseSelRaf=null;
let caseSelCamTargetX=0,caseSelCamCurrentX=0;
const caseSelRaycaster=new THREE.Raycaster(),caseSelMouse=new THREE.Vector2();

const CASE_DEFS=[
  {id:'gtr',title:'Great Train Robbery',year:'1963',color:0xcc4422,emissive:0xcc2200,labelId:'cl-gtr',pos:[-5.5,0.2,0],rot:[0,0.25,0]},
  {id:'band',title:'The Speckled Band',year:'1892',color:0x2244aa,emissive:0x1133cc,labelId:'cl-band',pos:[0,0.5,-1.5],rot:[0,0,0]},
  {id:'hound',title:'Hound of Baskervilles',year:'1902',color:0x336633,emissive:0x224422,labelId:'cl-hound',pos:[5.5,0.2,0],rot:[0,-0.25,0]}
];

function initCaseSelection(){
  const canvas=document.getElementById('case-sel-canvas');
  caseSelScene=new THREE.Scene();caseSelScene.background=new THREE.Color(0x01010a);caseSelScene.fog=new THREE.FogExp2(0x01010a,0.025);
  caseSelCamera=new THREE.PerspectiveCamera(58,innerWidth/innerHeight,0.1,500);caseSelCamera.position.set(0,1,18);caseSelCamera.lookAt(0,0,0);
  caseSelRenderer=new THREE.WebGLRenderer({canvas,antialias:true});caseSelRenderer.setSize(innerWidth,innerHeight);caseSelRenderer.setPixelRatio(Math.min(devicePixelRatio,2));
  caseSelRenderer.toneMapping=THREE.ACESFilmicToneMapping;caseSelRenderer.toneMappingExposure=1.1;caseSelClock=new THREE.Clock();
  caseSelScene.add(new THREE.AmbientLight(0x050510,0.55));
  const kl=new THREE.DirectionalLight(0xd4a840,1.4);kl.position.set(-6,12,8);caseSelScene.add(kl);
  const rl=new THREE.DirectionalLight(0x1a3388,0.55);rl.position.set(8,3,-10);caseSelScene.add(rl);
  const accentColors=[0xcc4422,0x2244cc,0x228833];
  [[-5.5,8,0],[0,8,-1.5],[5.5,8,0]].forEach((pos,i)=>{const al=new THREE.PointLight(accentColors[i],0.6,12);al.position.set(...pos);caseSelScene.add(al);});
  const spot=new THREE.SpotLight(0xd4af37,2.2,32,Math.PI*.16,0.35);spot.position.set(0,15,3);caseSelScene.add(spot);caseSelScene.add(spot.target);
  const fireGlow=new THREE.PointLight(0xff7722,0.8,20);fireGlow.position.set(-9,-2,3);caseSelScene.add(fireGlow);window._caseSelFire=fireGlow;

  // Floor grid
  const floorGrid=new THREE.GridHelper(40,20,0xd4af37,0xd4af37);floorGrid.material.transparent=true;floorGrid.material.opacity=0.03;floorGrid.position.y=-4.5;caseSelScene.add(floorGrid);

  buildCaseSelObjects();buildCaseSelFloor();buildCaseSelParticles();
  canvas.addEventListener('mousemove',onCaseSelMouseMove);canvas.addEventListener('click',onCaseSelClick);
  document.addEventListener('mousemove',e=>{caseSelCamTargetX=((e.clientX/innerWidth)*2-1)*2.0;});
  caseSelObjects.forEach((obj,i)=>{
    obj.mesh.position.z+=8;
    gsap.to(obj.mesh.position,{z:obj.mesh.position.z-8,duration:1.0,delay:i*.18,ease:'power3.out'});
    gsap.to(obj.mesh.userData.aura.material,{opacity:0.04,duration:0.8,delay:i*.18+0.4});
    const lbl=document.getElementById(CASE_DEFS[i].labelId);
    if(lbl)setTimeout(()=>lbl.classList.add('show'),(i*.18+0.5)*1000);
  });
  caseSelLoop();
}

function buildCaseSelObjects(){
  caseSelObjects=[];
  CASE_DEFS.forEach((def,i)=>{
    const group=new THREE.Group();group.position.set(...def.pos);group.rotation.set(...def.rot);
    group.userData={id:def.id,baseY:def.pos[1],idx:i,def};caseSelScene.add(group);
    const folderMat=new THREE.MeshStandardMaterial({color:def.color,roughness:0.65,metalness:0.1,emissive:def.emissive,emissiveIntensity:0.08});
    const folder=new THREE.Mesh(new THREE.BoxGeometry(3.0,4.0,0.12),folderMat);group.add(folder);
    for(let p=0;p<3;p++){
      const paper=new THREE.Mesh(new THREE.BoxGeometry(2.6,3.6,0.02),new THREE.MeshStandardMaterial({color:0xf0e8d0,roughness:0.92}));
      paper.position.set((Math.random()-.5)*.1,(Math.random()-.5)*.08,0.08+p*.015);paper.rotation.z=(Math.random()-.5)*.04;group.add(paper);
    }
    const seal=new THREE.Mesh(new THREE.TorusGeometry(0.55,0.04,8,32),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.45}));
    seal.position.set(0,-0.6,0.14);group.add(seal);
    const aura=new THREE.Mesh(new THREE.SphereGeometry(2.6,16,16),new THREE.MeshBasicMaterial({color:def.color,transparent:true,opacity:0.04,side:THREE.BackSide}));
    group.add(aura);group.userData.aura=aura;
    const orbit=new THREE.Mesh(new THREE.TorusGeometry(2.4,0.025,12,64),new THREE.MeshBasicMaterial({color:0xd4af37,transparent:true,opacity:0.2}));
    orbit.rotation.x=Math.PI*.4;group.add(orbit);group.userData.orbit=orbit;
    caseSelObjects.push({mesh:group,def,baseY:def.pos[1]});
  });
}

function buildCaseSelFloor(){
  const floor=new THREE.Mesh(new THREE.PlaneGeometry(60,60),new THREE.MeshStandardMaterial({color:0x05050e,roughness:0.3,metalness:0.45}));
  floor.rotation.x=-Math.PI/2;floor.position.y=-4.5;caseSelScene.add(floor);
}

function buildCaseSelParticles(){
  const n=300,geo=new THREE.BufferGeometry(),pos=new Float32Array(n*3),vel=[];
  for(let i=0;i<n*3;i+=3){
    pos[i]=(Math.random()-.5)*35;pos[i+1]=(Math.random()-.5)*14;pos[i+2]=(Math.random()-.5)*25;
    vel.push({x:(Math.random()-.5)*.006,y:(Math.random()-.5)*.004});
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const pts=new THREE.Points(geo,new THREE.PointsMaterial({color:0xc0b080,size:0.1,transparent:true,opacity:0.22,blending:THREE.AdditiveBlending,depthWrite:false}));
  caseSelScene.add(pts);window._caseSelParticles={mesh:pts,vel,pos};
}

function onCaseSelMouseMove(e){
  caseSelMouse.x=(e.clientX/innerWidth)*2-1;caseSelMouse.y=-(e.clientY/innerHeight)*2+1;
  caseSelRaycaster.setFromCamera(caseSelMouse,caseSelCamera);
  let hit=-1;
  caseSelObjects.forEach((obj,i)=>{if(caseSelRaycaster.intersectObjects(obj.mesh.children,true).length>0)hit=i;});
  if(hit!==caseSelHovered){caseSelHovered=hit;updateCaseSelHover();}
}

function onCaseSelClick(e){
  caseSelRaycaster.setFromCamera(caseSelMouse,caseSelCamera);
  let hit=-1;
  caseSelObjects.forEach((obj,i)=>{if(caseSelRaycaster.intersectObjects(obj.mesh.children,true).length>0)hit=i;});
  if(hit>=0)selectCase(CASE_DEFS[hit].id,hit);
}

function updateCaseSelHover(){
  caseSelObjects.forEach((obj,i)=>{
    const isHov=i===caseSelHovered;
    const auraOp=isHov?.2:(caseSelHovered>=0?.02:.06);
    gsap.to(obj.mesh.userData.aura.material,{opacity:auraOp,duration:0.45});
    gsap.to(obj.mesh.userData.orbit.material,{opacity:isHov?.88:(caseSelHovered>=0?.12:.22),duration:0.4});
    gsap.to(obj.mesh.position,{y:obj.mesh.userData.baseY+(isHov?.55:0),duration:0.55,ease:'power2.out'});
    // 3D tilt toward camera on hover
    gsap.to(obj.mesh.rotation,{x:isHov?-.12:0,y:isHov?CASE_DEFS[i].rot[1]*.5:CASE_DEFS[i].rot[1],duration:0.5});
    const lbl=document.getElementById(CASE_DEFS[i].labelId);
    if(lbl){lbl.classList.add('show');lbl.classList.toggle('case-hovered',isHov);lbl.style.opacity=isHov?'1':(caseSelHovered>=0?'0.35':'0.75');}
  });
  document.getElementById('case-sel-canvas').style.cursor=caseSelHovered>=0?'pointer':'default';
}

function updateCaseSelLabels(){
  caseSelObjects.forEach((obj,i)=>{
    const lbl=document.getElementById(CASE_DEFS[i].labelId);if(!lbl)return;
    const worldPos=new THREE.Vector3();obj.mesh.getWorldPosition(worldPos);
    const screen=worldToScreen(worldPos,caseSelCamera);
    lbl.style.left=screen.x+'px';lbl.style.top=(screen.y+140)+'px';lbl.style.transform='translate(-50%, 0)';
  });
}

function caseSelLoop(){
  if(currentPhase!=='case-sel')return;
  caseSelRaf=requestAnimationFrame(caseSelLoop);
  const t=caseSelClock.getElapsedTime();
  caseSelCamCurrentX+=(caseSelCamTargetX-caseSelCamCurrentX)*.045;
  caseSelCamera.position.x=caseSelCamCurrentX;
  // Subtle z-depth drift for extra 3D feel
  caseSelCamera.position.z=18+Math.sin(t*.15)*.4;
  caseSelCamera.lookAt(0,0,0);
  caseSelObjects.forEach((obj,i)=>{
    const isHov=i===caseSelHovered;
    obj.mesh.position.y=obj.mesh.userData.baseY+Math.sin(t*.65+i*1.4)*.1+(isHov?.5:0);
    if(obj.mesh.userData.orbit)obj.mesh.userData.orbit.rotation.z=t*.25*(i%2===0?1:-1);
    obj.mesh.children.forEach(ch=>{if(ch.material&&ch.material.emissiveIntensity!==undefined)ch.material.emissiveIntensity=0.06+Math.sin(t*1.2+i)*.04;});
  });
  if(window._caseSelParticles){
    const ps=window._caseSelParticles,p=ps.mesh.geometry.attributes.position.array;
    ps.vel.forEach((v,i)=>{const x=i*3;p[x]+=v.x;p[x+1]+=v.y;if(Math.abs(p[x])>17)p[x]*=-.95;if(Math.abs(p[x+1])>7)p[x+1]*=-.95;});
    ps.mesh.geometry.attributes.position.needsUpdate=true;
  }
  if(window._caseSelFire)window._caseSelFire.intensity=0.7+Math.sin(t*8.4)*.2+Math.sin(t*14.2)*.1;
  updateCaseSelLabels();
  caseSelRenderer.render(caseSelScene,caseSelCamera);
}

function selectCase(caseId,idx){
  const obj=caseSelObjects[idx].mesh,worldPos=new THREE.Vector3();obj.getWorldPosition(worldPos);
  gsap.to(caseSelCamera.position,{x:worldPos.x*.4,y:worldPos.y+0.3,z:6,duration:1.3,ease:'power3.inOut',onComplete:()=>transitionToMindPalace(caseId)});
  gsap.to(obj.userData.aura.material,{opacity:0.35,duration:0.8});
  caseSelObjects.forEach((o,i)=>{if(i!==idx)gsap.to(o.mesh.position,{z:o.mesh.position.z-5,duration:0.8,ease:'power2.in'});});
}

function transitionToMindPalace(caseId){
  const wipe=document.getElementById('scene-wipe');wipe.classList.add('in');
  setTimeout(()=>{
    currentPhase='mind-palace';cancelAnimationFrame(caseSelRaf);
    document.getElementById('case-sel-canvas').style.display='none';
    document.getElementById('case-sel-title').classList.remove('show');
    document.getElementById('case-sel-hint').style.opacity='0';
    ['cl-gtr','cl-band','cl-hound'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('show');});
    activeCase=CASES.find(c=>c.id===caseId)||CASES[0];activeCaseChapter=0;
    document.getElementById('three-canvas').style.display='block';
    initThree();
    enterMindPalaceHub();
    wipe.classList.remove('in');wipe.classList.add('out');
    setTimeout(()=>wipe.classList.remove('out'),700);
  },680);
}

function enterMindPalaceHub(){
  showScreen('s-hub');
  document.getElementById('hub-title').classList.add('show');
  const exitBtn=document.getElementById('hub-to-entry');if(exitBtn)exitBtn.classList.add('show');
  const eyebrow=document.getElementById('hub-eyebrow');const caseName=document.getElementById('hub-case-name');
  if(eyebrow)eyebrow.textContent='THE MIND PALACE';
  if(caseName&&activeCase)caseName.textContent='â€” '+activeCase.title.toUpperCase()+' â€”';
  buildPortalLabels();
  const labels=document.querySelectorAll('.portal-label');
  labels.forEach((l,i)=>{
    l.classList.remove('show');l.style.opacity='0';l.style.transform='translate(-50%,-50%) scale(0.6) translateY(20px)';
    setTimeout(()=>{
      l.classList.add('show');
      l.style.transform='translate(-50%,-50%) scale(1)';
      l.style.transition='opacity .7s ease, transform .7s cubic-bezier(.34,1.56,.64,1)';
    },350+i*160);
  });
  document.getElementById('ded-mode-btn').style.display='flex';
  if(activeCase&&SHERLOCK_LINES.caseEnter)sherlockSpeak('caseEnter');else sherlockSpeak('hubQuotes');
}

// roundRect polyfill
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.beginPath();this.moveTo(x+r,y);this.lineTo(x+w-r,y);this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r);this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h);this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r);this.quadraticCurveTo(x,y,x+r,y);this.closePath();
  };
}

window.addEventListener('load',()=>{
  buildPortalLabels();
  document.getElementById('tl-track').addEventListener('wheel',e=>{e.preventDefault();document.getElementById('tl-track').scrollLeft+=e.deltaY;},{passive:false});
  const fill=document.getElementById('load-fill');let v=0;
  const iv=setInterval(()=>{
    v+=Math.random()*20+2;if(v>=100){
      v=100;clearInterval(iv);
      setTimeout(()=>{
        document.getElementById('loading').classList.add('fade');
        setTimeout(()=>{
          document.getElementById('loading').style.display='none';
          initEntryHub();
          document.getElementById('s-entry').classList.add('show');
          setTimeout(()=>{document.getElementById('entry-title').classList.add('show');document.getElementById('entry-bottom').classList.add('show');},600);
          setTimeout(()=>{'lbl-case lbl-shop lbl-watch'.split(' ').forEach((id,i)=>setTimeout(()=>{const el=document.getElementById(id);if(el)el.classList.add('show');},i*200));},1400);
        },1300);
      },500);
    }
    fill.style.width=v+'%';
  },180);
});

function goHub(){
  if(currentPhase==='mind-palace'){
    if(typeof deductionActive!=='undefined'&&deductionActive)toggleDeductionMode();
    if(currentScreen==='s-suspects'){cancelAnimationFrame(suspAnimFrame2);suspAnimFrame2=null;document.getElementById('susp-info').classList.remove('show');}
    enterMindPalaceHub();return;
  }
  const wipe=document.getElementById('scene-wipe');wipe.classList.add('in');
  setTimeout(()=>{
    if(typeof deductionActive!=='undefined'&&deductionActive)toggleDeductionMode();
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
    document.getElementById('hub-title')?.classList.remove('show');
    document.querySelectorAll('.portal-label').forEach(l=>l.classList.remove('show'));
    currentPhase='entry';
    if(typeof caseSelRaf!=='undefined')cancelAnimationFrame(caseSelRaf);
    document.getElementById('case-sel-canvas').style.display='none';
    document.getElementById('case-sel-title').classList.remove('show');
    document.getElementById('case-sel-hint').style.opacity='0';
    ['cl-gtr','cl-band','cl-hound'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('show');});
    document.getElementById('three-canvas').style.display='none';
    document.getElementById('entry-canvas').style.display='block';
    document.getElementById('s-entry').classList.add('show');
    document.getElementById('entry-title').classList.add('show');
    document.getElementById('entry-bottom').classList.add('show');
    if(entryCamera){entryCamera.position.set(0,1.2,18);entryCamera.lookAt(0,0.5,0);entryCamera.rotation.set(0,0,0);}
    if(entryObjects&&entryObjects.shelf)gsap.to(entryObjects.shelf.position,{z:-3.5,duration:0.5});
    if(entryObjects&&entryObjects.projector)gsap.to(entryObjects.projector.position,{z:-1.5,duration:0.5});
    entryLoop();
    setTimeout(()=>{'lbl-case lbl-shop lbl-watch'.split(' ').forEach((id,i)=>setTimeout(()=>{const el=document.getElementById(id);if(el)el.classList.add('show');},i*150));},400);
    wipe.classList.remove('in');wipe.classList.add('out');setTimeout(()=>wipe.classList.remove('out'),700);
  },650);
}
</script>
</body>
</html>